<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Semiconductor Physics Virtual Lab</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.25.2/plotly.min.js"></script>
    <style>
        /* Common styles for Virtual Labs experiments */
        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .gradient-bg {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
        }

        .card {
            transition: all 0.3s ease;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin: 10px;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .btn {
            transition: all 0.2s;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-family: 'Poppins', sans-serif;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #e879f9, #c084fc);
            color: white;
        }

        /* Floating action buttons & panels */
        .floating-button {
            position: fixed;
            width: 3.5rem;
            height: 3.5rem;
            border-radius: 50%;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            border: none;
        }

        .floating-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 14px rgba(0,0,0,0.25);
        }

        .floating-button.primary {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            bottom: 2rem;
            right: 2rem;
        }

        .floating-button.secondary {
            background: linear-gradient(135deg, #e879f9, #c084fc);
            color: white;
            bottom: 6.5rem;
            right: 2rem;
        }

        .floating-panel {
            position: fixed;
            max-width: 22rem;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            z-index: 99;
            bottom: 7rem;
            right: 2rem;
            transform-origin: bottom right;
            transform: scale(0);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 1.5rem;
        }

        .floating-panel.active {
            transform: scale(1);
            opacity: 1;
        }

        .container {
            max-width: 100vw;
            margin: 0;
            padding: 20px 0;
            width: 100%;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .experiment-tabs {
            display: flex;
            justify-content: center;
            margin: 0 20px 25px 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 8px;
            backdrop-filter: blur(10px);
        }

        .tab {
            padding: 12px 24px;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            color: rgba(255, 255, 255, 0.8);
            margin: 0 4px;
        }

        .tab.active {
            background: rgba(255, 255, 255, 0.9);
            color: #6366f1;
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.3);
        }

        .tab:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .experiment-content {
            display: none;
            height: calc(100vh - 140px);
            overflow-y: auto;
            padding-bottom: 20px;
        }

        .experiment-content.active {
            display: block;
        }

        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin: 0 20px 20px 20px;
            min-height: fit-content;
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .controls-panel {
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            height: fit-content;
            max-height: 85vh;
            overflow-y: auto;
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #374151;
        }

        .control-group select, .control-group input {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-family: 'Poppins', sans-serif;
        }

        .preset-section {
            background: #f8fafc;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
        }

        .preset-section h4 {
            color: #374151;
            font-size: 0.85rem;
            margin-bottom: 8px;
            text-align: center;
        }

        .preset-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .btn-preset {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            padding: 6px 10px;
            font-size: 0.75rem;
            margin: 2px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .btn-preset:hover {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .material-info {
            background: #f8fafc;
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
            font-size: 0.85rem;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .info-card {
            background: #f8fafc;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .info-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .info-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
        }

        .info-label {
            font-size: 0.875rem;
            color: #6b7280;
            margin-top: 5px;
        }

        .point-info {
            background: #e0f2fe;
            border-radius: 8px;
            padding: 10px;
            margin-top: 12px;
            border-left: 4px solid #0277bd;
            font-size: 0.85rem;
        }

        .formula {
            background: #f3e8ff;
            border-radius: 8px;
            padding: 12px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            text-align: center;
            border-left: 4px solid #8b5cf6;
        }

        .band-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        .physics-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            grid-column: 1 / -1;
            margin: 0 20px;
        }

        .physics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .carrier-visualization {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
            height: 450px;
            overflow: hidden;
        }

        .carrier-dot {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            transition: all 0.3s ease;
            z-index: 10;
            cursor: pointer;
        }

        .electron {
            background: radial-gradient(circle, #60a5fa, #3b82f6);
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.9), 0 0 30px rgba(59, 130, 246, 0.4);
            border: 1px solid #1e40af;
            animation: electronGlow 2s ease-in-out infinite alternate;
        }

        .hole {
            background: radial-gradient(circle, #f87171, #ef4444);
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.9), 0 0 30px rgba(239, 68, 68, 0.4);
            border: 2px solid #ffffff;
            animation: holeGlow 2.2s ease-in-out infinite alternate;
        }

        @keyframes electronGlow {
            0% { box-shadow: 0 0 15px rgba(59, 130, 246, 0.9), 0 0 30px rgba(59, 130, 246, 0.4); }
            100% { box-shadow: 0 0 20px rgba(59, 130, 246, 1), 0 0 40px rgba(59, 130, 246, 0.6); }
        }

        @keyframes holeGlow {
            0% { box-shadow: 0 0 15px rgba(239, 68, 68, 0.9), 0 0 30px rgba(239, 68, 68, 0.4); }
            100% { box-shadow: 0 0 20px rgba(239, 68, 68, 1), 0 0 40px rgba(239, 68, 68, 0.6); }
        }

        .carrier-fast {
            animation-duration: 0.15s !important;
            transform: scale(1.2);
        }

        .recombination-flash {
            position: absolute;
            width: 20px;
            height: 20px;
            background: radial-gradient(circle, #fbbf24, transparent);
            border-radius: 50%;
            animation: recombinationBurst 0.8s ease-out forwards;
            pointer-events: none;
            z-index: 15;
        }

        @keyframes recombinationBurst {
            0% { 
                transform: scale(0.1); 
                opacity: 1; 
                box-shadow: 0 0 20px #fbbf24;
            }
            50% { 
                transform: scale(1.5); 
                opacity: 0.8; 
                box-shadow: 0 0 40px #fbbf24, 0 0 60px #f59e0b;
            }
            100% { 
                transform: scale(2.5); 
                opacity: 0; 
                box-shadow: 0 0 80px transparent;
            }
        }

        .trajectory-line {
            stroke: rgba(148, 163, 184, 0.6);
            stroke-width: 1;
            fill: none;
            stroke-dasharray: 2, 3;
            animation: trajectoryFlow 3s linear infinite;
        }

        @keyframes trajectoryFlow {
            0% { stroke-dashoffset: 0; }
            100% { stroke-dashoffset: 10; }
        }

        .band-structure {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            height: 400px;
        }

        .dos-visualization {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .temperature-effects {
            background: linear-gradient(135deg, #fef3c7, #fed7aa);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 20px 0 20px;
        }

        .temperature-indicator {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 10px;
        }

        .temp-cold {
            background: #dbeafe;
            color: #1e40af;
        }

        .temp-room {
            background: #dcfce7;
            color: #166534;
        }

        .temp-hot {
            background: #fef2f2;
            color: #991b1b;
        }

        .animation-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            justify-content: center;
        }

        .play-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .play-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .pause-btn {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }

        .pause-btn:hover {
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }

        .quantum-effects {
            background: linear-gradient(135deg, #e0e7ff, #c7d2fe);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 20px 0 20px;
            border-left: 4px solid #6366f1;
        }

        .measurement-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .advanced-measurement {
            background: white;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            border-left: 4px solid #8b5cf6;
            transition: all 0.3s ease;
        }

        .advanced-measurement:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.2);
        }

        .parameter-slider {
            margin: 8px 0;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .slider-label {
            min-width: 110px;
            font-size: 0.8rem;
            color: #374151;
        }

        .slider-value {
            min-width: 70px;
            font-weight: 600;
            color: #6366f1;
            font-size: 0.85rem;
        }

        /* GUIDED TOUR STYLES */
        .floating-button {
            position: fixed;
            width: 3.5rem;
            height: 3.5rem;
            border-radius: 50%;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .floating-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 14px rgba(0,0,0,0.25);
        }

        .floating-button:active {
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .floating-button.primary {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            bottom: 2rem;
            right: 2rem;
        }

        .floating-button.tour {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            bottom: 6.5rem;
            right: 2rem;
            font-size: 1.2rem;
        }

        .floating-panel {
            position: fixed;
            max-width: 18rem;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            z-index: 99;
            bottom: 7rem;
            right: 2rem;
            transform-origin: bottom right;
            transform: scale(0);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 1.5rem;
        }

        .floating-panel.active {
            transform: scale(1);
            opacity: 1;
        }

        .floating-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .floating-panel-close {
            cursor: pointer;
            color: #6b7280;
            width: 1.5rem;
            height: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .floating-panel-content {
            max-height: calc(80vh - 3rem);
            overflow-y: auto;
        }

        .panel-title {
            font-weight: 600;
            font-size: 1.1rem;
            color: #1f2937;
            margin: 0;
        }

        .tour-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            z-index: 99998;
            display: none;
            pointer-events: none;
        }

        .tour-overlay.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        .tour-spotlight {
            position: absolute;
            background: rgba(59, 130, 246, 0.1);
            border: 3px solid #3b82f6;
            border-radius: 8px;
            transition: all 0.5s ease;
            z-index: 99999;
            pointer-events: none;
            box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4);
            animation: spotlight-pulse 2s ease-in-out infinite;
        }

        @keyframes spotlight-pulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4);
                border-color: #3b82f6;
            }
            50% {
                box-shadow: 0 0 0 15px rgba(59, 130, 246, 0);
                border-color: #1d4ed8;
            }
        }

        .tour-spotlight-secondary {
            position: absolute;
            background: transparent;
            border: 2px solid #8b5cf6;
            border-radius: 8px;
            transition: all 0.5s ease;
            z-index: 99999;
            pointer-events: none;
            box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.4);
            animation: secondary-pulse 2s ease-in-out infinite;
        }

        @keyframes secondary-pulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.4);
            }
            50% {
                box-shadow: 0 0 0 15px rgba(139, 92, 246, 0);
            }
        }

        .tour-popup {
            position: fixed;
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 100000;
            min-width: 300px;
            max-width: 450px;
            transform: scale(0.8);
            opacity: 0;
            transition: all 0.3s ease;
            pointer-events: auto;
            border: 2px solid #e5e7eb;
        }

        .tour-popup.active {
            transform: scale(1);
            opacity: 1;
        }

        .tour-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .tour-step-number {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-right: 12px;
        }

        .tour-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1f2937;
            margin: 0;
        }

        .tour-content {
            color: #4b5563;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .tour-challenge {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border: 2px solid #f59e0b;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .tour-challenge-title {
            font-weight: 600;
            color: #92400e;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
        }

        .tour-challenge-title i {
            margin-right: 8px;
        }

        .tour-challenge-content {
            color: #78350f;
            font-size: 0.9rem;
        }

        .tour-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
        }

        .tour-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tour-btn-primary {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
        }

        .tour-btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }

        .tour-btn:hover {
            transform: translateY(-1px);
        }

        .tour-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .tour-score {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            z-index: 10002;
            display: none;
            pointer-events: auto;
        }

        .tour-score.active {
            display: block;
            animation: slideInRight 0.5s ease-out;
        }

        .tour-score-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 10px;
        }

        .tour-score-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .tour-achievements {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            z-index: 10001;
            text-align: center;
            display: none;
        }

        .tour-achievements.active {
            display: block;
            animation: popIn 0.5s ease-out;
        }

        .achievement-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .achievement-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 10px;
        }

        .achievement-description {
            color: #6b7280;
            margin-bottom: 20px;
        }

        .highlight-element {
            animation: pulse-highlight 2s ease-in-out 3;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        @keyframes popIn {
            from { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        @keyframes pulse-highlight {
            0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            50% { box-shadow: 0 0 0 12px rgba(59, 130, 246, 0); }
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .physics-grid {
                grid-template-columns: 1fr;
            }

            .experiment-tabs {
                flex-direction: column;
                gap: 8px;
            }

            .preset-grid {
                grid-template-columns: 1fr;
            }
        }

        /* CHALLENGE TAB STYLES */
        .challenge-container {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            max-height: 80vh;
            overflow-y: auto;
        }

        .challenge-section {
            margin-bottom: 40px;
            padding: 25px;
            border-radius: 12px;
            border: 2px solid #e5e7eb;
            transition: all 0.3s ease;
        }

        .challenge-section:hover {
            border-color: #6366f1;
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.1);
        }

        .challenge-section.completed {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .challenge-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .challenge-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 20px;
            font-size: 1.8rem;
        }

        .challenge-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #1f2937;
            margin: 0;
        }

        .challenge-description {
            color: #6b7280;
            font-size: 0.95rem;
            margin-top: 8px;
        }

        .quiz-question {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 8px;
            border-left: 4px solid #6366f1;
        }

        .quiz-question h4 {
            margin-bottom: 15px;
            color: #1f2937;
            font-size: 1.1rem;
        }

        .quiz-options {
            display: grid;
            gap: 12px;
        }

        .quiz-option {
            padding: 12px 16px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .quiz-option:hover {
            border-color: #6366f1;
            background: #f8fafc;
            transform: translateX(5px);
        }

        .quiz-option.selected {
            border-color: #6366f1;
            background: #eff6ff;
            color: #1e40af;
        }

        .quiz-option.correct {
            border-color: #10b981;
            background: #d1fae5;
            color: #065f46;
        }

        .quiz-option.incorrect {
            border-color: #ef4444;
            background: #fee2e2;
            color: #991b1b;
        }

        .fill-blank-container {
            margin: 20px 0;
        }

        .fill-blank-text {
            font-size: 1.1rem;
            line-height: 1.6;
            color: #374151;
        }

        .fill-blank-input {
            display: inline-block;
            min-width: 100px;
            padding: 6px 12px;
            border: 2px solid #6366f1;
            border-radius: 6px;
            background: #eff6ff;
            font-weight: 600;
            text-align: center;
            margin: 0 4px;
        }

        .fill-blank-input:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .fill-blank-input.correct {
            border-color: #10b981;
            background: #d1fae5;
            color: #065f46;
        }

        .fill-blank-input.incorrect {
            border-color: #ef4444;
            background: #fee2e2;
            color: #991b1b;
        }

        .matching-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin: 20px 0;
            position: relative;
        }

        .matching-column {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .matching-item {
            padding: 15px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            position: relative;
        }

        .matching-item:hover {
            border-color: #6366f1;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
        }

        .matching-item.selected {
            border-color: #6366f1;
            background: #eff6ff;
            color: #1e40af;
        }

        .matching-item.matched {
            border-color: #10b981;
            background: #d1fae5;
            color: #065f46;
        }

        .matching-item.correct-match {
            border-color: #10b981;
            background: #d1fae5;
            color: #065f46;
        }

        .matching-item.incorrect-match {
            border-color: #ef4444;
            background: #fee2e2;
            color: #991b1b;
        }

        .challenge-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        .challenge-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-family: 'Poppins', sans-serif;
        }

        .challenge-btn-primary {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
        }

        .challenge-btn-secondary {
            background: #f3f4f6;
            color: #374151;
            border: 2px solid #e5e7eb;
        }

        .challenge-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .challenge-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .challenge-feedback {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            font-weight: 500;
            display: none;
        }

        .challenge-feedback.success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid #10b981;
        }

        .challenge-feedback.error {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid #ef4444;
        }

        .challenge-progress {
            background: #f3f4f6;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
        }

        .challenge-progress-bar {
            height: 100%;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            transition: width 0.5s ease;
        }

        .challenge-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #6366f1;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #6b7280;
            margin-top: 5px;
        }

        .challenge-hint {
            background: #fffbeb;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            display: none;
            animation: slideDown 0.3s ease;
        }

        .challenge-hint.active {
            display: block;
        }

        .explanation-panel {
            background: #f0f9ff;
            border-left: 4px solid #0284c7;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            display: none;
            animation: slideDown 0.3s ease;
        }

        .explanation-panel.active {
            display: block;
        }

        .explanation-title {
            font-weight: 600;
            color: #0c4a6e;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .explanation-content {
            color: #1e40af;
            line-height: 1.6;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .numerical-problem {
            background: #fef7ff;
            border-left: 4px solid #a855f7;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .numerical-input {
            display: inline-block;
            width: 120px;
            padding: 8px 12px;
            border: 2px solid #a855f7;
            border-radius: 6px;
            background: white;
            font-weight: 600;
            text-align: center;
            margin: 0 8px;
        }

        .unit-display {
            font-weight: 600;
            color: #7c3aed;
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <div class="container">


        <div class="experiment-tabs">
            <button class="tab active" onclick="switchTab(this, 'bandstructure')">Band Structure</button>
            <button class="tab" onclick="switchTab(this, 'transport')">Carrier Transport</button>
            <button class="tab" onclick="switchTab(this, 'temperature')">Temperature Analysis</button>
            <button class="tab" onclick="switchTab(this, 'challenges')">Challenges</button>
        </div>

        <!-- Band Structure Experiment -->
        <div id="bandstructure" class="experiment-content active">
            <div class="main-content">
                <div class="chart-container">
                    <h3>Understanding E-K diagram and related parameters (v<sub>g</sub>, P, m*)</h3>
                    <div class="animation-controls">
                        <button class="btn play-btn" onclick="toggleAnimation('bandstructure')"> Show Electron Property on the E-k curve</button>
                    </div>
                    <div id="ekChart" style="height: 400px;"></div>
                    
                    <div id="animationStatus" style="text-align: center; margin: 10px 0; padding: 8px; background: rgba(99, 102, 241, 0.1); border-radius: 6px; font-weight: 500; color: #6366f1; display: none;">
                        <span id="animationStatusText">üîÑ Showing electron transitions...</span>
                    </div>
                    
                    <div class="band-legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #1f77b4;"></div>
                            <span>Conduction Band</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #ff7f0e;"></div>
                            <span>Valence Band</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #d62728;"></div>
                            <span>Fermi Level</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #2ca02c;"></div>
                            <span>Conduction Electrons</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #ff7f0e;"></div>
                            <span>Valence Electrons</span>
                        </div>
                    </div>
                </div>

                <div class="controls-panel">
                    <h3>Material & Parameters</h3>
                    
                    <div class="control-group">
                        <label for="materialSelect">Semiconductor Material:</label>
                        <select id="materialSelect">
                            <option value="si">Silicon (Si)</option>
                            <option value="gaas">Gallium Arsenide (GaAs)</option>
                            <option value="ge">Germanium (Ge)</option>
                            <option value="gan">Gallium Nitride (GaN)</option>
                            <option value="inp">Indium Phosphide (InP)</option>
                            <option value="sic">Silicon Carbide (SiC)</option>
                        </select>
                    </div>

                    <div class="material-info">
                        <h4 id="materialName">Silicon (Si)</h4>
                        <div id="materialProperties"></div>
                    </div>












                    <div class="parameter-slider">
                        <div class="slider-container">
                            <span class="slider-label">k-vector (1/m √ó 10<sup>9</sup>):</span>
                            <input type="range" id="kValue" min="-3" max="3" step="0.01" value="0" style="flex: 1;">
                            <span class="slider-value" id="kDisplay">0.00</span>
                        </div>
                    </div>

                    <div class="parameter-slider">
                        <div class="slider-container">
                            <span class="slider-label">Temperature (K):</span>
                            <input type="range" id="temperatureSlider" min="4" max="800" step="10" value="300" style="flex: 1;">
                            <span class="slider-value" id="tempDisplay">300</span>
                        </div>
                    </div>

                    <div class="parameter-slider">
                        <div class="slider-container">
                            <span class="slider-label">Doping (cm<sup>-3</sup>):</span>
                            <input type="range" id="dopingSlider" min="14" max="20" step="0.1" value="15" style="flex: 1;">
                            <span class="slider-value" id="dopingDisplay">10<sup>15</sup></span>
                        </div>
                    </div>
                    
                    <div class="point-info">
                        <h4>Selected Point Info</h4>
                        <div id="pointDetails">
                            <p><strong>k:</strong> 0.000 √ó 10<sup>9</sup> m<sup>-1</sup></p>
                            <p><strong>E<sub>c</sub>:</strong> 0.560 eV</p>
                            <p><strong>E<sub>v</sub>:</strong> -0.560 eV</p>
                            <p><strong>ŒîE:</strong> 1.120 eV</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="physics-panel">
                <h3>Advanced Physics Analysis</h3>
                <div class="physics-grid">
                    <div class="info-card">
                        <div class="info-value" id="groupVelocity">0.00</div>
                        <div class="info-label">Group Velocity (m/s √ó 10<sup>5</sup>)</div>
                        <div class="formula">v<sub>g</sub> = (1/‚Ñè) √ó dE/dk</div>
                    </div>

                    <div class="info-card">
                        <div class="info-value" id="momentum">0.00</div>
                        <div class="info-label">Crystal Momentum (kg¬∑m/s √ó 10<sup>-24</sup>)</div>
                        <div class="formula">p = ‚Ñèk</div>
                    </div>

                    <div class="info-card">
                        <div class="info-value" id="effectiveMass">0.00</div>
                        <div class="info-label">Effective Mass (m<sub>0</sub>)</div>
                        <div class="formula">m* = ‚Ñè<sup>2</sup> / (d<sup>2</sup>E/dk<sup>2</sup>)</div>
                    </div>

                    <div class="info-card">
                        <div class="info-value" id="bandgap">1.12</div>
                        <div class="info-label">Bandgap Energy (eV)</div>
                        <div class="formula">E<sub>g</sub> = E<sub>c</sub> - E<sub>v</sub></div>
                    </div>

                    <div class="info-card">
                        <div class="info-value" id="carrierDensity">1.45√ó10<sup>10</sup></div>
                        <div class="info-label">Intrinsic Density (cm<sup>-3</sup>)</div>
                        <div class="formula">n<sub>i</sub> = ‚àö(N<sub>c</sub> N<sub>v</sub>) exp(-E<sub>g</sub>/2kT)</div>
                    </div>

                    <div class="info-card">
                        <div class="info-value" id="fermiLevel">0.56</div>
                        <div class="info-label">Fermi Level (eV)</div>
                        <div class="formula">E<sub>f</sub> = E<sub>i</sub> + kT ln(N<sub>d</sub>/n<sub>i</sub>)</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Carrier Transport Experiment -->
        <div id="transport" class="experiment-content">
            <div class="main-content" style="display: grid; grid-template-columns: 180px 1fr minmax(280px, 320px); gap: 8px; margin: 0 15px 20px 15px; max-width: calc(100vw - 30px);">
                <!-- Physics Legend Sidebar -->
                <div class="physics-legend" style="background: linear-gradient(135deg, #334155, #475569); padding: 12px; border-radius: 12px; border: 2px solid #475569; height: fit-content; min-height: 280px; display: flex; flex-direction: column;">
                    <h4 style="margin: 0 0 10px 0; color: white; font-size: 13px; text-align: center;">Legend</h4>
                    <div style="font-size: 11px; color: #e2e8f0; line-height: 1.4; flex-grow: 1;">
                        <div style="display: flex; align-items: center; margin-bottom: 8px;">
                            <span style="width: 12px; height: 12px; background: #3b82f6; border-radius: 50%; margin-right: 8px; flex-shrink: 0; box-shadow: 0 0 8px rgba(59, 130, 246, 0.6);"></span>
                            <span><strong style="color: #60a5fa;">Electrons:</strong> Move opposite to E-field</span>
                        </div>
                        <div style="display: flex; align-items: center; margin-bottom: 8px;">
                            <span style="width: 12px; height: 12px; background: transparent; border: 2px solid #ef4444; border-radius: 50%; margin-right: 8px; flex-shrink: 0; box-shadow: 0 0 8px rgba(239, 68, 68, 0.6);"></span>
                            <span><strong style="color: #f87171;">Holes:</strong> Move with E-field</span>
                        </div>
                        <div style="margin-bottom: 8px;">
                            <span style="color: #60a5fa;">üåä <strong>Diffusion:</strong></span><br>
                            <span style="margin-left: 16px; font-size: 10px;">Random thermal motion</span>
                        </div>
                        <div style="margin-bottom: 8px;">
                            <span style="color: #a78bfa;">‚ö° <strong>Drift:</strong></span><br>
                            <span style="margin-left: 16px; font-size: 10px;">Field-driven motion</span>
                        </div>
                        <div>
                            <span style="color: #fbbf24;">üí• <strong>Recombination:</strong></span><br>
                            <span style="margin-left: 16px; font-size: 10px;">e<sup>-</sup> + h<sup>+</sup> ‚Üí photon</span>
                        </div>
                    </div>
                </div>
                
                <div class="carrier-visualization">
                    <h3>Carrier Transport Simulation</h3>
                    <div class="animation-controls">
                        <button class="btn play-btn" onclick="startCarrierAnimation()">‚ñ∂ Start Simulation</button>
                        <button class="btn pause-btn" onclick="pauseCarrierAnimation()">‚è∏ Pause</button>
                        <button class="btn btn-secondary" onclick="resetCarrierAnimation()">üîÑ Reset</button>
                    </div>
                    
                    <!-- Enhanced Transport Visualization -->
                    <div id="transportContainer" style="position: relative; height: 280px; background: linear-gradient(135deg, #1e293b, #334155); border-radius: 12px; overflow: hidden; border: 2px solid #475569;">
                        <!-- Electric Field Indicator -->
                        <div id="fieldIndicator" style="position: absolute; top: 8px; left: 8px; right: 8px; height: 24px; background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.3), transparent); border-radius: 4px; display: none;">
                            <div style="position: absolute; top: 3px; left: 50%; transform: translateX(-50%); color: #60a5fa; font-size: 11px; font-weight: 600;">‚ö° Electric Field ‚ö°</div>
                        </div>
                        
                        <!-- Crystal Lattice Background -->
                        <div id="latticeBackground" style="position: absolute; width: 100%; height: 100%; opacity: 0.1;"></div>
                        
                        <!-- Carrier Trajectories -->
                        <svg id="trajectoryLayer" style="position: absolute; width: 100%; height: 100%; pointer-events: none;">
                        </svg>
                        
                        <!-- Carrier Particles -->
                        <div id="carrierField" style="position: absolute; width: 100%; height: 100%;"></div>
                        
                        <!-- Information Overlay -->
                        <div id="transportInfo" style="position: absolute; bottom: 8px; left: 8px; background: rgba(0,0,0,0.7); color: white; padding: 6px; border-radius: 4px; font-size: 10px; min-width: 180px;">
                            <div id="transportStatus">‚è∏ Simulation Paused</div>
                            <div id="dominantMechanism">Dominant: Thermal Motion</div>
                            <div id="fieldStrength">Field Strength: 0 V/cm</div>
                        </div>
                        
                        <!-- Recombination Events -->
                        <div id="recombinationLayer" style="position: absolute; width: 100%; height: 100%; pointer-events: none;"></div>
                    </div>
                </div>

                <div class="controls-panel">
                    <h3>Transport Parameters</h3>
                    
                    <div class="preset-section">
                        <h4>Transport Scenarios</h4>
                        <div class="preset-grid">
                            <button class="btn-preset" onclick="applyTransportPreset('drift')">‚ö° Drift</button>
                            <button class="btn-preset" onclick="applyTransportPreset('diffusion')">üåä Diffusion</button>
                            <button class="btn-preset" onclick="applyTransportPreset('hot')">üî• Hot Carriers</button>
                            <button class="btn-preset" onclick="applyTransportPreset('ballistic')">üöÄ Ballistic</button>
                        </div>
                    </div>

                    <div class="parameter-slider">
                        <div class="slider-container">
                            <span class="slider-label">Electric Field (V/cm):</span>
                            <input type="range" id="electricField" min="0" max="2000" step="50" value="0" style="flex: 1;">
                            <span class="slider-value" id="fieldDisplay">0</span>
                        </div>
                    </div>

                    <div class="parameter-slider">
                        <div class="slider-container">
                            <span class="slider-label">Mobility (cm<sup>2</sup>/V¬∑s):</span>
                            <input type="range" id="mobility" min="100" max="2000" step="25" value="1400" style="flex: 1;">
                            <span class="slider-value" id="mobilityDisplay">1400</span>
                        </div>
                    </div>

                    <div class="parameter-slider">
                        <div class="slider-container">
                            <span class="slider-label">Carrier Density (cm<sup>-3</sup>):</span>
                            <input type="range" id="carrierDensitySlider" min="14" max="18" step="0.1" value="16" style="flex: 1;">
                            <span class="slider-value" id="densityDisplay">10<sup>16</sup></span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="physics-panel">
                <h3>Transport Properties</h3>
                <div class="measurement-grid">
                    <div class="advanced-measurement">
                        <div class="info-value" id="driftVelocity">0.0</div>
                        <div class="info-label">Drift Velocity (cm/s)</div>
                    </div>
                    <div class="advanced-measurement">
                        <div class="info-value" id="conductivity">0.0</div>
                        <div class="info-label">Conductivity (S/cm)</div>
                    </div>
                    <div class="advanced-measurement">
                        <div class="info-value" id="current">0.0</div>
                        <div class="info-label">Current Density (A/cm<sup>2</sup>)</div>
                    </div>
                    <div class="advanced-measurement">
                        <div class="info-value" id="resistivity">0.0</div>
                        <div class="info-label">Resistivity (Œ©¬∑cm)</div>
                    </div>
                    <div class="advanced-measurement">
                        <div class="info-value" id="diffusionLength">0.0</div>
                        <div class="info-label">Diffusion Length (Œºm)</div>
                    </div>
                    <div class="advanced-measurement">
                        <div class="info-value" id="meanFreePath">0.0</div>
                        <div class="info-label">Mean Free Path (nm)</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Temperature Analysis Experiment -->
        <div id="temperature" class="experiment-content">
            <div class="main-content">
                <div class="chart-container">
        
                    <div class="animation-controls">
                        <button class="btn play-btn" onclick="startTemperatureSweep()">‚ñ∂ Temperature Sweep</button>
                        <button class="btn pause-btn" onclick="pauseTemperatureSweep()">‚è∏ Pause</button>
                        <button class="btn btn-secondary" onclick="resetTemperatureSweep()">üîÑ Reset</button>
                    </div>
                    <div id="temperatureChart" style="height: 650px; width: 100%;"></div>
                </div>

                <div class="controls-panel">
                    <h3>Temperature Control</h3>
                    
                    <div class="preset-section">
                        <h4>Temperature Presets</h4>
                        <div class="preset-grid">
                            <button class="btn-preset" onclick="setTemperature(4)">‚ùÑÔ∏è 4K</button>
                            <button class="btn-preset" onclick="setTemperature(77)">üßä 77K</button>
                            <button class="btn-preset" onclick="setTemperature(300)">üè† 300K</button>
                            <button class="btn-preset" onclick="setTemperature(600)">üî• 600K</button>
                        </div>
                    </div>

                    <div class="parameter-slider">
                        <div class="slider-container">
                            <span class="slider-label">Temperature (K):</span>
                            <input type="range" id="tempSlider" min="4" max="800" step="5" value="300" style="flex: 1;">
                            <span class="slider-value" id="tempValue">300</span>
                            <span class="temperature-indicator temp-room" id="tempIndicator">Room Temp</span>
                        </div>
                    </div>

                    <div class="parameter-slider">
                        <div class="slider-container">
                            <span class="slider-label">Analysis Range:</span>
                            <input type="range" id="rangeSlider" min="50" max="800" step="25" value="600" style="flex: 1;">
                            <span class="slider-value" id="rangeValue">600K</span>
                        </div>
                    </div>
                    
                    <!-- Temperature Properties Grid -->
                    <div style="margin-top: 20px;">
                        <h4 style="color: #374151; font-size: 0.9rem; margin-bottom: 12px; text-align: center;">Temperature Properties</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div class="advanced-measurement" style="margin: 0; padding: 10px; font-size: 0.8rem;">
                                <div class="info-value" id="intrinsicDensity" style="font-size: 1.1rem;">1.45√ó10<sup>10</sup></div>
                                <div class="info-label" style="font-size: 0.75rem;">Intrinsic Density (cm<sup>-3</sup>)</div>
                            </div>
                            <div class="advanced-measurement" style="margin: 0; padding: 10px; font-size: 0.8rem;">
                                <div class="info-value" id="bandgapTemp" style="font-size: 1.1rem;">1.12</div>
                                <div class="info-label" style="font-size: 0.75rem;">Bandgap (eV)</div>
                            </div>
                            <div class="advanced-measurement" style="margin: 0; padding: 10px; font-size: 0.8rem;">
                                <div class="info-value" id="mobilityTemp" style="font-size: 1.1rem;">1400</div>
                                <div class="info-label" style="font-size: 0.75rem;">Mobility (cm<sup>2</sup>/V¬∑s)</div>
                            </div>
                            <div class="advanced-measurement" style="margin: 0; padding: 10px; font-size: 0.8rem;">
                                <div class="info-value" id="thermalVelocity" style="font-size: 1.1rem;">1.0√ó10<sup>7</sup></div>
                                <div class="info-label" style="font-size: 0.75rem;">Thermal Velocity (cm/s)</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Challenges Tab -->
        <div id="challenges" class="experiment-content">
            <div class="challenge-container">
                <div style="text-align: center; margin-bottom: 30px;">
                    <h2 style="color: #1f2937; margin-bottom: 10px;">üß† Semiconductor Physics Challenges</h2>
                    <p style="color: #6b7280; font-size: 1.1rem;">Test your understanding with problems and quizzes</p>
                    
                    <div class="challenge-stats">
                        <div class="stat-item">
                            <div class="stat-value" id="totalScore">0</div>
                            <div class="stat-label">Total Score</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="completedChallenges">0</div>
                            <div class="stat-label">Completed</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="hintsUsed">0</div>
                            <div class="stat-label">Hints Used</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="accuracy">0%</div>
                            <div class="stat-label">Accuracy</div>
                        </div>
                    </div>

                    <div class="challenge-progress">
                        <div class="challenge-progress-bar" id="challengeProgressBar" style="width: 0%;"></div>
                    </div>
                </div>

                <!-- Challenge 1: Band Structure MCQs -->
                <div class="challenge-section" id="challenge1">
                    <div class="challenge-header">
                        <div class="challenge-icon" style="background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white;">
                            üéØ
                        </div>
                        <div>
                            <h3 class="challenge-title">Band Structure Fundamentals</h3>
                            <p class="challenge-description">Test your knowledge of energy bands and electron behavior</p>
                        </div>
                    </div>

                    <div id="quiz1Content">
                        <!-- Questions will be generated dynamically -->
                    </div>

                    <div class="challenge-controls">
                        <button class="challenge-btn challenge-btn-secondary" onclick="showQuizHints(1)">üí° Show Hints</button>
                        <button class="challenge-btn challenge-btn-primary" onclick="checkQuizAnswers(1)">‚úÖ Check Answers</button>
                        <button class="challenge-btn challenge-btn-secondary" onclick="resetChallenge(1)">üîÑ Reset</button>
                    </div>

                    <div class="challenge-hint" id="challenge1Hint">
                        <strong>üí° Hints:</strong>
                        <ul>
                            <li>Remember: E-k diagrams show the relationship between energy and momentum</li>
                            <li>Effective mass is related to the curvature of the band structure</li>
                            <li>Direct bandgap materials have conduction band minimum at the same k as valence band maximum</li>
                        </ul>
                    </div>

                    <div class="challenge-feedback" id="challenge1Feedback"></div>
                </div>

                <!-- Challenge 2: Carrier Transport -->
                <div class="challenge-section" id="challenge2">
                    <div class="challenge-header">
                        <div class="challenge-icon" style="background: linear-gradient(135deg, #10b981, #059669); color: white;">
                            ‚ö°
                        </div>
                        <div>
                            <h3 class="challenge-title">Carrier Transport Mechanisms</h3>
                            <p class="challenge-description">Advanced concepts in electron and hole transport</p>
                        </div>
                    </div>

                    <div id="advancedContent">
                        <!-- Advanced questions will be generated -->
                    </div>

                    <div class="challenge-controls">
                        <button class="challenge-btn challenge-btn-secondary" onclick="showAdvancedHints()">üí° Show Hints</button>
                        <button class="challenge-btn challenge-btn-primary" onclick="checkAdvancedAnswers()">‚úÖ Check Answers</button>
                        <button class="challenge-btn challenge-btn-secondary" onclick="resetChallenge(2)">üîÑ Reset</button>
                    </div>

                    <div class="challenge-hint" id="challenge2Hint">
                        <strong>üí° Advanced Hints:</strong>
                        <ul>
                            <li>Drift velocity is proportional to electric field for low fields</li>
                            <li>Mobility depends on scattering mechanisms and temperature</li>
                            <li>Diffusion occurs due to concentration gradients</li>
                        </ul>
                    </div>

                    <div class="challenge-feedback" id="challenge2Feedback"></div>
                </div>

                <!-- Challenge 3: Fill in the Blanks -->
                <div class="challenge-section" id="challenge3">
                    <div class="challenge-header">
                        <div class="challenge-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white;">
                            üìù
                        </div>
                        <div>
                            <h3 class="challenge-title">Fill in the Blanks</h3>
                            <p class="challenge-description">Complete the semiconductor physics equations and concepts</p>
                        </div>
                    </div>

                    <div id="fillBlanksContent">
                        <!-- Fill in blanks content will be generated -->
                    </div>

                    <div class="challenge-controls">
                        <button class="challenge-btn challenge-btn-secondary" onclick="showFillBlanksHint()">üí° Show Hints</button>
                        <button class="challenge-btn challenge-btn-primary" onclick="checkFillBlanks()">‚úÖ Check Answers</button>
                        <button class="challenge-btn challenge-btn-secondary" onclick="resetChallenge(3)">üîÑ Reset</button>
                    </div>

                    <div class="challenge-hint" id="challenge3Hint">
                        <strong>üí° Equation Hints:</strong>
                        <ul>
                            <li>Effective mass: m* = ‚Ñè<sup>2</sup>/(d<sup>2</sup>E/dk<sup>2</sup>)</li>
                            <li>Fermi-Dirac: f(E) = 1/(1 + exp((E-EF)/kBT))</li>
                            <li>Drift current: J = nqŒºE</li>
                        </ul>
                    </div>

                    <div class="challenge-feedback" id="challenge3Feedback"></div>
                </div>

                <!-- Challenge 4: Numerical Problems -->
                <div class="challenge-section" id="challenge4">
                    <div class="challenge-header">
                        <div class="challenge-icon" style="background: linear-gradient(135deg, #8b5cf6, #a855f7); color: white;">
                            üî¢
                        </div>
                        <div>
                            <h3 class="challenge-title">Numerical Calculations</h3>
                            <p class="challenge-description">Solve quantitative problems in semiconductor physics</p>
                        </div>
                    </div>

                    <div id="calculationContent">
                        <!-- Numerical problems will be generated -->
                    </div>

                    <div class="challenge-controls">
                        <button class="challenge-btn challenge-btn-secondary" onclick="showCalculationHint()">üí° Show Hints</button>
                        <button class="challenge-btn challenge-btn-primary" onclick="checkCalculations()">‚úÖ Check Answers</button>
                        <button class="challenge-btn challenge-btn-secondary" onclick="resetChallenge(4)">üîÑ Reset</button>
                    </div>

                    <div class="challenge-hint" id="challenge4Hint">
                        <strong>üí° Calculation Tips:</strong>
                        <ul>
                            <li>Pay attention to units - convert appropriately</li>
                            <li>Use scientific notation for very large or small numbers</li>
                            <li>Room temperature ‚âà 300K, kBT ‚âà 0.026 eV</li>
                        </ul>
                    </div>

                    <div class="challenge-feedback" id="challenge4Feedback"></div>
                </div>

                <!-- Challenge 5: Matching Exercise -->
                <div class="challenge-section" id="challenge5">
                    <div class="challenge-header">
                        <div class="challenge-icon" style="background: linear-gradient(135deg, #ec4899, #be185d); color: white;">
                            üîó
                        </div>
                        <div>
                            <h3 class="challenge-title">Concept Matching</h3>
                            <p class="challenge-description">Match semiconductor concepts with their descriptions</p>
                        </div>
                    </div>

                    <div id="matchingContent">
                        <!-- Matching exercise will be generated -->
                    </div>

                    <div class="challenge-controls">
                        <button class="challenge-btn challenge-btn-secondary" onclick="showMatchingHints()">üí° Show Hints</button>
                        <button class="challenge-btn challenge-btn-primary" onclick="checkMatching()">‚úÖ Check Answers</button>
                        <button class="challenge-btn challenge-btn-secondary" onclick="resetChallenge(5)">üîÑ Reset</button>
                    </div>

                    <div class="challenge-hint" id="challenge5Hint">
                        <strong>üí° Matching Tips:</strong>
                        <ul>
                            <li>Click on items to select them, then click on matching items</li>
                            <li>Think about fundamental relationships between concepts</li>
                            <li>Consider both theoretical and practical applications</li>
                        </ul>
                    </div>

                    <div class="challenge-feedback" id="challenge5Feedback"></div>
                </div>

                <!-- Final Challenge Controls -->
                <div style="text-align: center; margin-top: 40px; padding: 30px; background: #f8fafc; border-radius: 12px;">
                    <h3 style="color: #1f2937; margin-bottom: 20px;">üèÜ Challenge Master</h3>
                    <div class="challenge-controls">
                        <button class="challenge-btn challenge-btn-primary" onclick="resetAllChallenges()">üîÑ Reset All Challenges</button>
                        <button class="challenge-btn challenge-btn-secondary" onclick="exportResults()">üìä Export Results</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Controls -->
    <button class="floating-button primary" onclick="togglePanel('theory')" title="Theory">
        üìö
    </button>

    <button class="floating-button secondary" onclick="togglePanel('help')" title="Help">
        ‚ùì
    </button>

    <div id="theoryPanel" class="floating-panel">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="margin: 0;">Theory Reference</h3>
            <span onclick="togglePanel('theory')" style="cursor: pointer; font-size: 1.5rem;">√ó</span>
        </div>
        <div>
            <h4>E-k Relations</h4>
            <p>The energy-momentum relationship determines carrier dynamics and transport properties in semiconductors.</p>
            
            <h4>Effective Mass</h4>
            <p>The curvature of energy bands determines how carriers respond to external forces: m* = ‚Ñè<sup>2</sup>/(d<sup>2</sup>E/dk<sup>2</sup>).</p>
            
            <h4>Quantum Confinement</h4>
            <p>When carrier motion is restricted in one or more dimensions, energy levels become quantized.</p>
            
            <h4>Temperature Effects</h4>
            <p>Temperature affects carrier concentrations, mobilities, and energy distributions through Fermi-Dirac statistics.</p>
        </div>
    </div>

    <div id="helpPanel" class="floating-panel">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="margin: 0;">Help</h3>
            <span onclick="togglePanel('help')" style="cursor: pointer; font-size: 1.5rem;">√ó</span>
        </div>
        <div>
            <h4>Navigation</h4>
            <ul>
                <li><strong>Band Structure:</strong> Explore E-k diagrams and effective mass calculations</li>
                <li><strong>Transport:</strong> Simulate carrier drift and diffusion</li>
                <li><strong>Quantum:</strong> Analyze quantum confinement effects</li>
                <li><strong>Temperature:</strong> Study temperature-dependent properties</li>
            </ul>
            
            <h4>Controls</h4>
            <ul>
                <li>Use preset buttons for quick parameter changes</li>
                <li>Drag sliders to adjust values in real-time</li>
                <li>Click on plots to select specific points</li>
                <li>Use animation controls for dynamic visualizations</li>
            </ul>
        </div>
    </div>

    <script>
        // Physical constants
        const hbar = 1.054571817e-34; // J‚ãÖs
        const m0 = 9.1093837015e-31; // kg (electron mass)
        const eV = 1.602176634e-19; // J
        const kB = 1.380649e-23; // J/K
        const q = 1.602176634e-19; // C

        // Enhanced material properties
        const materials = {
            si: {
                name: "Silicon (Si)",
                bandgap: 1.12, // eV at 300K
                effectiveMassElectron: 0.26, // m0
                effectiveMassHole: 0.39, // m0
                latticeConstant: 5.43, // √Ö
                mobility_e: 1400, // cm¬≤/V‚ãÖs
                mobility_h: 450, // cm¬≤/V‚ãÖs
                dielectric: 11.7,
                ni_300: 1.45e10, // cm‚Åª¬≥
                description: "Indirect bandgap, most common semiconductor",
                bandgapTemp: -2.73e-4, // eV/K (Varshni parameter)
                crystalStructure: "Diamond cubic"
            },
            gaas: {
                name: "Gallium Arsenide (GaAs)",
                bandgap: 1.42, // eV
                effectiveMassElectron: 0.067, // m0
                effectiveMassHole: 0.48, // m0
                latticeConstant: 5.65, // √Ö
                mobility_e: 8500, // cm¬≤/V‚ãÖs
                mobility_h: 400, // cm¬≤/V‚ãÖs
                dielectric: 13.1,
                ni_300: 1.8e6, // cm‚Åª¬≥
                description: "Direct bandgap, excellent for optoelectronics",
                bandgapTemp: -5.4e-4, // eV/K
                crystalStructure: "Zinc blende"
            },
            ge: {
                name: "Germanium (Ge)",
                bandgap: 0.67, // eV
                effectiveMassElectron: 0.22, // m0
                effectiveMassHole: 0.34, // m0
                latticeConstant: 5.66, // √Ö
                mobility_e: 3900, // cm¬≤/V‚ãÖs
                mobility_h: 1900, // cm¬≤/V‚ãÖs
                dielectric: 16.0,
                ni_300: 2.4e13, // cm‚Åª¬≥
                description: "Indirect bandgap, used in infrared applications",
                bandgapTemp: -3.9e-4, // eV/K
                crystalStructure: "Diamond cubic"
            },
            gan: {
                name: "Gallium Nitride (GaN)",
                bandgap: 3.4, // eV
                effectiveMassElectron: 0.20, // m0
                effectiveMassHole: 0.80, // m0
                latticeConstant: 3.19, // √Ö
                mobility_e: 1200, // cm¬≤/V‚ãÖs
                mobility_h: 200, // cm¬≤/V‚ãÖs
                dielectric: 9.0,
                ni_300: 1.9e-10, // cm‚Åª¬≥
                description: "Wide bandgap, ideal for power electronics and LEDs",
                bandgapTemp: -7.7e-4, // eV/K
                crystalStructure: "Wurtzite"
            },
            inp: {
                name: "Indium Phosphide (InP)",
                bandgap: 1.35, // eV
                effectiveMassElectron: 0.077, // m0
                effectiveMassHole: 0.60, // m0
                latticeConstant: 5.87, // √Ö
                mobility_e: 4600, // cm¬≤/V‚ãÖs
                mobility_h: 150, // cm¬≤/V‚ãÖs
                dielectric: 12.4,
                ni_300: 1.3e7, // cm‚Åª¬≥
                description: "High-speed electronics and photonics",
                bandgapTemp: -4.9e-4, // eV/K
                crystalStructure: "Zinc blende"
            },
            sic: {
                name: "Silicon Carbide (SiC)",
                bandgap: 3.26, // eV (4H-SiC)
                effectiveMassElectron: 0.25, // m0
                effectiveMassHole: 0.70, // m0
                latticeConstant: 3.08, // √Ö
                mobility_e: 950, // cm¬≤/V‚ãÖs
                mobility_h: 120, // cm¬≤/V‚ãÖs
                dielectric: 9.7,
                ni_300: 8.2e-9, // cm‚Åª¬≥
                description: "Wide bandgap, high-power, high-temperature applications",
                bandgapTemp: -3.3e-4, // eV/K
                crystalStructure: "Hexagonal (4H)"
            }
        };

        let currentMaterial = 'si';
        let currentK = 0;
        let currentTab = 'bandstructure';
        let animationRunning = false;
        let animationId;
        let carrierAnimationRunning = false;
        let quantumAnimationRunning = false;
        let temperatureSweepRunning = false;

        // Challenge system variables
        let challengeAnswers = {
            quiz1: {},
            advanced: {},
            fillBlanks: {},
            calculations: {},
            matching: []
        };

        let challengeStates = {
            1: { completed: false, score: 0 },
            2: { completed: false, score: 0 },
            3: { completed: false, score: 0 },
            4: { completed: false, score: 0 },
            5: { completed: false, score: 0 }
        };

        let totalScore = 0;
        let completedChallenges = 0;
        let hintsUsed = 0;
        let totalQuestions = 0;
        let correctAnswers = 0;

        // Selected questions for current session (randomized)
        let selectedQuestions = {
            bandStructure: [],
            transport: [],
            advanced: [],
            fillBlanks: [],
            numerical: [],
            matching: []
        };

        // Function to randomly select questions for each challenge type
        function selectRandomQuestions() {
            // Number of questions to select for each challenge type
            const selectionCounts = {
                bandStructure: 3,
                transport: 3, 
                advanced: 3,
                fillBlanks: 4,
                numerical: 3,
                matching: 1
            };

            // Randomly select questions for each category
            for (const category in selectionCounts) {
                const availableQuestions = questionBank[category];
                const count = Math.min(selectionCounts[category], availableQuestions.length);
                
                // Create array of indices and shuffle
                const indices = Array.from({length: availableQuestions.length}, (_, i) => i);
                for (let i = indices.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [indices[i], indices[j]] = [indices[j], indices[i]];
                }
                
                // Select first 'count' questions
                selectedQuestions[category] = indices.slice(0, count).map(i => availableQuestions[i]);
            }

            console.log('Selected questions for this session:', selectedQuestions);
        }

        // GUIDED TOUR SYSTEM
        let tourActive = false;
        let currentTourStep = 0;
        let tourScore = 0;
        let challengesSolved = 0;
        let helpPanelVisible = false;

        const tourSteps = [
            {
                target: ".header",
                title: "Welcome to Advanced Semiconductor Physics!",
                content: "This virtual lab explores advanced concepts in semiconductor physics including band structure, carrier transport, and temperature effects. You'll interact with real physics equations and simulations.<br><br><strong>üí° Tip:</strong> You can interact with all controls and visualizations even while the tour is running!",
                position: "bottom",
                challenge: null
            },
            {
                target: ".experiment-tabs",
                title: "Navigation Tabs",
                content: "The lab is organized into different sections:<br><strong>‚Ä¢ Band Structure:</strong> E-k relationships and effective mass<br><strong>‚Ä¢ Carrier Transport:</strong> Drift, diffusion, and advanced mechanisms<br><strong>‚Ä¢ Temperature Analysis:</strong> Temperature effects on carriers<br><strong>‚Ä¢ Challenges:</strong> physics problems",
                position: "bottom",
                challenge: null
            },
            {
                target: "#ekChart",
                title: "Band Structure Analysis",
                content: "This section lets you explore the E-k diagram and understand how band curvature affects carrier effective mass. The effective mass formula m* = ‚Ñè<sup>2</sup>/(d<sup>2</sup>E/dk<sup>2</sup>) shows the relationship between band curvature and carrier properties.",
                position: "right",
                challenge: {
                    type: "interaction",
                    task: "Click on the E-k diagram to see how the effective mass changes at different k-points.",
                    element: "#ekChart"
                }
            },
            {
                target: ".material-select",
                title: "Material Selection",
                content: "Choose different semiconductor materials to compare their band structures. Silicon, Germanium, and GaAs have different effective masses and band properties.",
                position: "left",
                challenge: {
                    type: "interaction",
                    task: "Select different materials and observe how the band structure changes.",
                    element: "#materialSelect"
                }
            },
            {
                target: "#transportContainer",
                title: "Carrier Transport Physics",
                content: "Understand how carriers move in semiconductors through drift (ŒºE field) and diffusion (D‚àán gradient). The Einstein relation D/Œº = kT/q connects these transport mechanisms.",
                position: "top",
                challenge: null
            },
            {
                target: "#transport .controls-panel",
                title: "Transport Parameters",
                content: "Adjust electric field, temperature, and doping to see how they affect carrier velocities and currents. Watch the animated particles show drift and diffusion processes.",
                position: "left",
                challenge: {
                    type: "interaction",
                    task: "Try the different transport scenarios (Drift, Diffusion, Hot Carriers) to see various transport regimes.",
                    element: ".preset-buttons"
                }
            },
            {
                target: "#temperatureChart",
                title: "Temperature Effects",
                content: "Temperature dramatically affects semiconductor behavior through carrier concentration (n<sub>i</sub> ‚àù exp(-E<sub>g</sub>/2kT)), mobility (Œº ‚àù T<sup>-n</sup>), and diffusion (D ‚àù T).",
                position: "right",
                challenge: null
            },
            {
                target: "#temperature .controls-panel",
                title: "Temperature Analysis Tools",
                content: "Use the temperature slider and range controls to study how carrier properties change with temperature. The Fermi-Dirac distribution f(E) = 1/(1+exp((E-E<sub>F</sub>)/kT)) governs carrier statistics.",
                position: "left",
                challenge: {
                    type: "interaction",
                    task: "Adjust the temperature and observe how it affects carrier distribution and transport properties.",
                    element: "#tempSlider"
                }
            },
            {
                target: ".challenge-container",
                title: "Challenges - End of Tour! üéâ",
                content: "Congratulations! You've completed the guided tour of Advanced Semiconductor Physics. This challenges section offers 5 different types of physics problems to test your understanding:<br><br><strong>‚Ä¢ Multiple Choice:</strong> Band structure fundamentals<br><strong>‚Ä¢ Fill-in-Blanks:</strong> Physics equations<br><strong>‚Ä¢ Numerical:</strong> Quantitative calculations<br><strong>‚Ä¢ Advanced:</strong> Complex concepts<br><strong>‚Ä¢ Matching:</strong> Concept relationships<br><br>üöÄ <strong>Start exploring and learning!</strong> The simulations and challenges await your discovery.",
                position: "center",
                challenge: null
            }
        ];

        function startGuidedTour() {
            if (tourActive) return;
            
            tourActive = true;
            currentTourStep = 0;
            tourScore = 0;
            challengesSolved = 0;
            hintsUsed = 0;
            
            document.getElementById('tourOverlay').classList.add('active');
            document.getElementById('tourScore').classList.add('active');
            
            showTourStep();
        }

        function switchToRelevantTab(target) {
            // Auto-switch to appropriate tab based on tour step target
            let requiredTab = null;
            
            if (target.includes('#bandstructure') || target.includes('#ekChart') || target.includes('#materialSelect')) {
                requiredTab = 'bandstructure';
            } else if (target.includes('#transport') || target.includes('#transportContainer') || target.includes('.preset-buttons')) {
                requiredTab = 'transport';
            } else if (target.includes('#temperature') || target.includes('#temperatureChart') || target.includes('#tempSlider')) {
                requiredTab = 'temperature';
            } else if (target.includes('#challenges') || target.includes('.challenge-container') || target.includes('.challenge-section') || target.includes('.challenge-stats')) {
                requiredTab = 'challenges';
            }
            
            if (requiredTab && requiredTab !== currentTab) {
                const tabButton = document.querySelector(`[onclick="switchTab(this, '${requiredTab}')"]`);
                if (tabButton) {
                    switchTab(tabButton, requiredTab);
                    // Allow time for tab switching animation
                    setTimeout(() => {
                        // Force re-render of tab-specific content
                        switch(requiredTab) {
                            case 'bandstructure':
                                plotEkDiagram();
                                break;
                            case 'transport':
                                plotTransport();
                                break;
                            case 'temperature':
                                plotTemperature();
                                break;
                        }
                    }, 300);
                }
            }
        }

        function showTourStep() {
            const step = tourSteps[currentTourStep];
            const popup = document.getElementById('tourPopup');
            
            // Auto-switch to appropriate tab based on target
            switchToRelevantTab(step.target);
            
            // Update popup content
            document.getElementById('tourStepNumber').textContent = currentTourStep + 1;
            document.getElementById('tourTitle').textContent = step.title;
            document.getElementById('tourContent').innerHTML = step.content;
            document.getElementById('tourStepInfo').textContent = `Step ${currentTourStep + 1} of ${tourSteps.length}`;
            
            // Handle challenge content
            const challengeContainer = document.getElementById('tourChallenge');
            if (step.challenge) {
                challengeContainer.innerHTML = `
                    <div class="tour-challenge">
                        <div class="tour-challenge-title">
                            <i class="fas fa-tasks"></i>
                             Challenge
                        </div>
                        <div class="tour-challenge-content">${step.challenge.task}</div>
                    </div>
                `;
                startChallengeMonitoring(step.challenge);
            } else {
                challengeContainer.innerHTML = '';
            }
            
            // Position tour elements
            positionTourElements(step);
            
            // Update navigation buttons
            document.getElementById('tourPrevBtn').disabled = currentTourStep === 0;
            document.getElementById('tourNextBtn').textContent = 
                currentTourStep === tourSteps.length - 1 ? 'Finish' : 'Next';
            
            // Show popup
            setTimeout(() => {
                popup.classList.add('active');
            }, 100);
        }

        function positionTourElements(step) {
            const spotlight = document.getElementById('tourSpotlight');
            const popup = document.getElementById('tourPopup');
            
            // Allow time for tab switching if needed
            setTimeout(() => {
                if (step.target === 'body' || step.position === 'center') {
                    // Center positioning for welcome/end steps
                    if (spotlight) spotlight.style.display = 'none';
                    if (popup) {
                        popup.style.position = 'fixed';
                        popup.style.top = '50%';
                        popup.style.left = '50%';
                        popup.style.transform = 'translate(-50%, -50%)';
                        popup.style.maxWidth = '500px';
                    }
                    return;
                }
                
                const target = document.querySelector(step.target);
                if (!target) {
                    console.warn(`Tour target not found: ${step.target}`);
                    // Target not found, use center positioning
                    if (spotlight) spotlight.style.display = 'none';
                    if (popup) {
                        popup.style.position = 'fixed';
                        popup.style.top = '50%';
                        popup.style.left = '50%';
                        popup.style.transform = 'translate(-50%, -50%)';
                        popup.style.maxWidth = '500px';
                    }
                    return;
                }
                
                console.log('Target found:', target);
                
                // Ensure target is visible
                target.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
                
                // Wait a bit for scroll to complete and charts to render
                const additionalDelay = (step.target === '#ekChart' || step.target === '#transportContainer' || step.target === '#temperatureChart') ? 200 : 100;
                setTimeout(() => {
                    const rect = target.getBoundingClientRect();
                    const viewportHeight = window.innerHeight;
                    const viewportWidth = window.innerWidth;
                    
                    // Position spotlight
                    if (spotlight) {
                        spotlight.style.display = 'block';
                        spotlight.style.position = 'fixed';
                        spotlight.style.top = Math.max(0, rect.top - 10) + 'px';
                        spotlight.style.left = Math.max(0, rect.left - 10) + 'px';
                        spotlight.style.width = Math.min(rect.width + 20, viewportWidth) + 'px';
                        spotlight.style.height = Math.min(rect.height + 20, viewportHeight) + 'px';
                        spotlight.style.zIndex = '9998';
                    }
                    
                    // Position popup with smart positioning
                    if (popup) {
                        popup.style.position = 'fixed';
                        popup.style.maxWidth = '400px';
                        popup.style.zIndex = '9999';
                        
                        let popupTop, popupLeft, transform;
                        const popupWidth = 400; // Approximate popup width
                        const popupHeight = 300; // Approximate popup height
                        
                        switch (step.position) {
                            case 'top':
                                if (rect.top > popupHeight + 50) {
                                    popupTop = rect.top - 30;
                                    popupLeft = Math.max(20, Math.min(viewportWidth - popupWidth - 20, rect.left + rect.width/2));
                                    transform = 'translate(-50%, -100%)';
                                } else {
                                    // Fallback to bottom if not enough space on top
                                    popupTop = rect.bottom + 20;
                                    popupLeft = Math.max(20, Math.min(viewportWidth - popupWidth - 20, rect.left + rect.width/2));
                                    transform = 'translate(-50%, 0)';
                                }
                                break;
                            case 'bottom':
                                if (rect.bottom < viewportHeight - popupHeight - 50) {
                                    popupTop = rect.bottom + 20;
                                    popupLeft = Math.max(20, Math.min(viewportWidth - popupWidth - 20, rect.left + rect.width/2));
                                    transform = 'translate(-50%, 0)';
                                } else {
                                    // Fallback to top if not enough space on bottom
                                    popupTop = rect.top - 30;
                                    popupLeft = Math.max(20, Math.min(viewportWidth - popupWidth - 20, rect.left + rect.width/2));
                                    transform = 'translate(-50%, -100%)';
                                }
                                break;
                            case 'left':
                                if (rect.left > popupWidth + 50) {
                                    popupTop = Math.max(20, Math.min(viewportHeight - popupHeight - 20, rect.top + rect.height/2));
                                    popupLeft = rect.left - 20;
                                    transform = 'translate(-100%, -50%)';
                                } else {
                                    // Fallback to right if not enough space on left
                                    popupTop = Math.max(20, Math.min(viewportHeight - popupHeight - 20, rect.top + rect.height/2));
                                    popupLeft = rect.right + 20;
                                    transform = 'translate(0, -50%)';
                                }
                                break;
                            case 'right':
                                if (rect.right < viewportWidth - popupWidth - 50) {
                                    popupTop = Math.max(20, Math.min(viewportHeight - popupHeight - 20, rect.top + rect.height/2));
                                    popupLeft = rect.right + 20;
                                    transform = 'translate(0, -50%)';
                                } else {
                                    // Fallback to left if not enough space on right
                                    popupTop = Math.max(20, Math.min(viewportHeight - popupHeight - 20, rect.top + rect.height/2));
                                    popupLeft = rect.left - 20;
                                    transform = 'translate(-100%, -50%)';
                                }
                                break;
                            default:
                                // Center positioning as fallback
                                popupTop = viewportHeight / 2;
                                popupLeft = viewportWidth / 2;
                                transform = 'translate(-50%, -50%)';
                        }
                        
                        popup.style.top = popupTop + 'px';
                        popup.style.left = popupLeft + 'px';
                        popup.style.transform = transform;
                    }
                }, additionalDelay);
            }, step.target.includes('#') && !step.target.includes('body') ? 400 : 100);
        }

        function startChallengeMonitoring(challenge) {
            if (challenge.type === 'interaction') {
                const element = document.querySelector(challenge.element);
                if (element) {
                    element.classList.add('highlight-element');
                    const handler = function() {
                        element.classList.remove('highlight-element');
                        element.removeEventListener('click', handler);
                        onChallengeCompleted(challenge);
                    };
                    element.addEventListener('click', handler);
                }
            } else if (challenge.type === 'challenge') {
                // Monitor challenge completion (this would be triggered by existing challenge functions)
                const element = document.querySelector(challenge.element);
                if (element) {
                    element.classList.add('highlight-element');
                }
            }
        }

        function onChallengeCompleted(challenge) {
            challengesSolved++;
            tourScore += 50;
            updateTourScore();
            
            // Show achievement
            showAchievement({
                title: "Challenge Complete!",
                description: "Great job! You've successfully completed the challenge.",
                icon: "üéØ"
            });
        }

        function nextTourStep() {
            const popup = document.getElementById('tourPopup');
            popup.classList.remove('active');
            
            setTimeout(() => {
                if (currentTourStep < tourSteps.length - 1) {
                    currentTourStep++;
                    tourScore += 10; // Points for progressing
                    updateTourScore();
                    showTourStep();
                } else {
                    finalizeTour();
                }
            }, 400); // Increased delay to allow for tab switching
        }

        function prevTourStep() {
            if (currentTourStep > 0) {
                const popup = document.getElementById('tourPopup');
                popup.classList.remove('active');
                
                setTimeout(() => {
                    currentTourStep--;
                    showTourStep();
                }, 400); // Increased delay to allow for tab switching
            }
        }

        function finalizeTour() {
            tourActive = false;
            
            document.getElementById('tourOverlay').classList.remove('active');
            document.getElementById('tourScore').classList.remove('active');
            
            // Clean up any highlights
            document.querySelectorAll('.highlight-element').forEach(el => {
                el.classList.remove('highlight-element');
            });
            
            // Show final achievement
            showAchievement({
                title: "Tour Complete! üéì",
                description: `Congratulations! You've earned ${tourScore} points and completed the guided tour. Now explore the advanced semiconductor physics simulations!`,
                icon: "üèÜ"
            });
        }

        function showAchievement(achievement) {
            const modal = document.getElementById('tourAchievements');
            document.getElementById('achievementTitle').textContent = achievement.title;
            document.getElementById('achievementDescription').textContent = achievement.description;
            document.querySelector('.achievement-icon').textContent = achievement.icon;
            
            modal.classList.add('active');
            
            // Auto-close after 3 seconds if no manual close
            setTimeout(() => {
                if (modal.classList.contains('active')) {
                    closeAchievement();
                }
            }, 3000);
        }

        function closeAchievement() {
            document.getElementById('tourAchievements').classList.remove('active');
        }

        function updateTourScore() {
            document.getElementById('stepsCompleted').textContent = `${currentTourStep + 1}/${tourSteps.length}`;
            document.getElementById('challengesSolved').textContent = `${challengesSolved}/5`;
            document.getElementById('totalScore').textContent = tourScore;
        }

        function toggleHelp() {
            const helpPanel = document.getElementById('helpPanel');
            helpPanelVisible = !helpPanelVisible;
            
            if (helpPanelVisible) {
                helpPanel.classList.add('active');
            } else {
                helpPanel.classList.remove('active');
            }
        }

        // Question bank for semiconductor physics (expanded for randomization)
        const questionBank = {
            bandStructure: [
                {
                    question: "What determines the effective mass of charge carriers in a semiconductor?",
                    options: [
                        "The curvature of the E-k diagram",
                        "The bandgap energy",
                        "The lattice constant",
                        "The doping concentration"
                    ],
                    correct: 0,
                    explanation: "The effective mass is inversely proportional to the second derivative of energy with respect to momentum (curvature of E-k bands). Higher curvature means lower effective mass and higher carrier mobility.",
                    hint: "Think about what the second derivative of E vs k represents mathematically"
                },
                {
                    question: "Which material has a direct bandgap?",
                    options: [
                        "Silicon (Si)",
                        "Germanium (Ge)", 
                        "Gallium Arsenide (GaAs)",
                        "Silicon Carbide (SiC)"
                    ],
                    correct: 2,
                    explanation: "GaAs has a direct bandgap where the conduction band minimum and valence band maximum occur at the same k-value, making it excellent for optoelectronic applications.",
                    hint: "Direct bandgap means the minimum of CB and maximum of VB are at the same k-point"
                },
                {
                    question: "What happens to the bandgap of most semiconductors as temperature increases?",
                    options: [
                        "It increases linearly",
                        "It decreases due to lattice expansion",
                        "It remains constant",
                        "It first increases then decreases"
                    ],
                    correct: 1,
                    explanation: "As temperature increases, thermal expansion and electron-phonon interactions cause the bandgap to decrease approximately linearly with temperature.",
                    hint: "Consider thermal expansion and electron-phonon coupling effects"
                },
                {
                    question: "In the E-k diagram, what does a flatter band indicate?",
                    options: [
                        "Higher effective mass and lower mobility",
                        "Lower effective mass and higher mobility",
                        "No change in effective mass",
                        "Higher carrier concentration"
                    ],
                    correct: 0,
                    explanation: "A flatter band has smaller curvature (d¬≤E/dk¬≤), which means higher effective mass and consequently lower carrier mobility.",
                    hint: "Flat means less curvature, which affects the effective mass"
                },
                {
                    question: "What is the primary difference between direct and indirect semiconductors?",
                    options: [
                        "Direct semiconductors have larger bandgaps",
                        "Indirect semiconductors need phonons for optical transitions",
                        "Direct semiconductors have higher doping levels",
                        "Indirect semiconductors have better electrical conductivity"
                    ],
                    correct: 1,
                    explanation: "In indirect semiconductors, the CB minimum and VB maximum are at different k-values, so optical transitions require both photons and phonons to conserve momentum.",
                    hint: "Think about momentum conservation in optical transitions"
                },
                {
                    question: "What is the Fermi level in an intrinsic semiconductor at 0K?",
                    options: [
                        "At the conduction band edge",
                        "At the valence band edge",
                        "Exactly at the middle of the bandgap",
                        "Does not exist"
                    ],
                    correct: 2,
                    explanation: "In an intrinsic semiconductor, the Fermi level lies exactly at the middle of the bandgap due to symmetry between electrons and holes.",
                    hint: "Think about the symmetry between electrons and holes in pure semiconductors"
                },
                {
                    question: "How does band bending occur at semiconductor interfaces?",
                    options: [
                        "Due to external electric fields only",
                        "Due to charge transfer to equalize Fermi levels",
                        "Due to temperature gradients",
                        "It doesn't occur in real devices"
                    ],
                    correct: 1,
                    explanation: "Band bending occurs when two materials with different Fermi levels come into contact, causing charge transfer until Fermi levels align.",
                    hint: "Consider what happens when materials with different work functions touch"
                },
                {
                    question: "What characterizes a degenerate semiconductor?",
                    options: [
                        "Very low doping concentration",
                        "Fermi level inside the conduction or valence band",
                        "Temperature-independent properties",
                        "Direct bandgap only"
                    ],
                    correct: 1,
                    explanation: "A degenerate semiconductor has such high doping that the Fermi level moves into the conduction or valence band, changing transport properties.",
                    hint: "Think about what happens with extremely high doping levels"
                },
                {
                    question: "What is the significance of the density of states in band structure?",
                    options: [
                        "It determines carrier concentration only",
                        "It affects optical absorption and carrier statistics",
                        "It only matters at low temperatures",
                        "It's independent of material properties"
                    ],
                    correct: 1,
                    explanation: "The density of states determines how many carriers can occupy energy levels, affecting carrier statistics, optical properties, and transport.",
                    hint: "Think about how many states are available at each energy level"
                }
            ],
            transport: [
                {
                    question: "The drift velocity of charge carriers is:",
                    options: [
                        "Always proportional to electric field",
                        "Proportional to field at low fields, saturates at high fields",
                        "Independent of electric field",
                        "Inversely proportional to electric field"
                    ],
                    correct: 1,
                    explanation: "At low electric fields, drift velocity is proportional to field (v = ŒºE). At high fields, scattering mechanisms dominate and velocity saturates.",
                    hint: "Consider what happens at low vs high electric fields"
                },
                {
                    question: "Which scattering mechanism dominates at room temperature in pure semiconductors?",
                    options: [
                        "Ionized impurity scattering",
                        "Phonon (lattice) scattering",
                        "Carrier-carrier scattering",
                        "Surface scattering"
                    ],
                    correct: 1,
                    explanation: "At room temperature, phonon scattering dominates in pure semiconductors. Mobility decreases with temperature as ~T^(-3/2) due to increased phonon population.",
                    hint: "At room temperature, what vibrates in the crystal lattice?"
                },
                {
                    question: "What is the Einstein relation in semiconductors?",
                    options: [
                        "D = ŒºkBT/q",
                        "D = ŒºE",
                        "D = qŒº/kBT",
                        "D = Œºq/kBT"
                    ],
                    correct: 0,
                    explanation: "The Einstein relation D = ŒºkBT/q relates the diffusion coefficient D to mobility Œº, connecting drift and diffusion transport mechanisms.",
                    hint: "This relates diffusion coefficient to mobility"
                },
                {
                    question: "In heavily doped semiconductors, what limits carrier mobility?",
                    options: [
                        "Phonon scattering only",
                        "Ionized impurity scattering",
                        "Surface scattering",
                        "Carrier-carrier scattering"
                    ],
                    correct: 1,
                    explanation: "In heavily doped semiconductors, ionized impurity scattering becomes dominant as the concentration of ionized dopant atoms increases.",
                    hint: "Heavy doping means many ionized atoms in the crystal"
                },
                {
                    question: "What is the Hall effect used to measure?",
                    options: [
                        "Bandgap energy",
                        "Carrier concentration and mobility",
                        "Temperature coefficient",
                        "Optical absorption"
                    ],
                    correct: 1,
                    explanation: "The Hall effect measures carrier concentration and mobility by observing the voltage developed perpendicular to current flow in a magnetic field.",
                    hint: "Think about what happens when carriers move in crossed electric and magnetic fields"
                },
                {
                    question: "What causes velocity saturation in semiconductors?",
                    options: [
                        "Temperature increase",
                        "High electric field causing increased scattering",
                        "Low carrier concentration",
                        "Band structure changes"
                    ],
                    correct: 1,
                    explanation: "At high electric fields, carriers gain enough energy to scatter more frequently with optical phonons, limiting their velocity.",
                    hint: "Consider what happens to hot carriers at very high fields"
                },
                {
                    question: "What is the difference between drift and diffusion current?",
                    options: [
                        "Drift requires electric field, diffusion requires concentration gradient",
                        "Drift is for electrons, diffusion is for holes",
                        "Drift occurs at high temperature, diffusion at low temperature",
                        "There is no difference"
                    ],
                    correct: 0,
                    explanation: "Drift current is driven by electric fields (J = nqŒºE), while diffusion current is driven by concentration gradients (J = qD‚àán).",
                    hint: "Think about the driving forces for each type of current"
                },
                {
                    question: "How does temperature affect carrier mobility?",
                    options: [
                        "Always increases with temperature",
                        "Always decreases with temperature",
                        "Decreases due to increased phonon scattering",
                        "Is independent of temperature"
                    ],
                    correct: 2,
                    explanation: "In pure semiconductors, mobility decreases with temperature as ~T^(-3/2) due to increased phonon scattering at higher temperatures.",
                    hint: "Consider how lattice vibrations change with temperature"
                }
            ],
            fillBlanks: [
                {
                    text: "The effective mass of an electron is given by m* = ‚Ñè¬≤/(d¬≤E/dk¬≤), where the second derivative represents the ____ of the energy band.",
                    answer: "curvature",
                    hint: "Think about the mathematical meaning of the second derivative"
                },
                {
                    text: "For a direct bandgap semiconductor, the conduction band minimum and valence band maximum occur at the same ____ value.",
                    answer: "k",
                    hint: "Consider the momentum space coordinate"
                },
                {
                    text: "The Fermi-Dirac distribution function is f(E) = 1/(1 + exp((E-EF)/__T)), where EF is the Fermi level.",
                    answer: "kB",
                    hint: "What is the Boltzmann constant symbol?"
                },
                {
                    text: "The density of states in 3D for electrons is proportional to E^(____), where E is the energy.",
                    answer: "1/2",
                    hint: "For a 3D system with parabolic bands"
                },
                {
                    text: "In quantum wells, carrier motion is confined in ____ dimension(s), leading to quantized energy levels.",
                    answer: "one",
                    hint: "A well confines motion in how many directions?"
                },
                {
                    text: "The carrier concentration in intrinsic semiconductors follows ni ‚àù T^(3/2) exp(-Eg/____T).",
                    answer: "2kB",
                    hint: "This comes from the thermal excitation across the bandgap"
                },
                {
                    text: "The drift velocity is related to mobility by vd = ____E, where E is the electric field.",
                    answer: "Œº",
                    hint: "What parameter relates velocity to electric field?"
                },
                {
                    text: "In the depletion approximation, the space charge region has ____ mobile carriers.",
                    answer: "zero",
                    hint: "What assumption does the depletion approximation make?"
                },
                {
                    text: "The built-in potential of a PN junction is Vbi = (kBT/q) ln(____/ni¬≤).",
                    answer: "NaNd",
                    hint: "This involves the product of doping concentrations"
                },
                {
                    text: "In band diagrams, energy increases in the ____ direction.",
                    answer: "upward",
                    hint: "Standard convention for energy axis"
                },
                {
                    text: "The continuity equation relates the time derivative of carrier concentration to the ____ of current density.",
                    answer: "divergence",
                    hint: "Think about conservation laws and vector calculus"
                }
            ],
            numerical: [
                {
                    question: "Calculate the effective mass of electrons in Silicon if the curvature d¬≤E/dk¬≤ = 3.2 √ó 10‚Åª¬≥‚Å∏ J‚ãÖm¬≤. Use ‚Ñè = 1.055 √ó 10‚Åª¬≥‚Å¥ J‚ãÖs and m‚ÇÄ = 9.11 √ó 10‚Åª¬≥¬π kg.",
                    answer: 0.35,
                    unit: "m‚ÇÄ",
                    tolerance: 0.05,
                    solution: "m* = ‚Ñè¬≤/(d¬≤E/dk¬≤) = (1.055√ó10‚Åª¬≥‚Å¥)¬≤/(3.2√ó10‚Åª¬≥‚Å∏) = 3.48√ó10‚Åª¬≥¬π kg = 0.35 m‚ÇÄ"
                },
                {
                    question: "At room temperature (300K), what is the thermal energy kBT in eV? Use kB = 1.38 √ó 10‚Åª¬≤¬≥ J/K and 1 eV = 1.602 √ó 10‚Åª¬π‚Åπ J.",
                    answer: 0.026,
                    unit: "eV",
                    tolerance: 0.002,
                    solution: "kBT = (1.38√ó10‚Åª¬≤¬≥ √ó 300)/(1.602√ó10‚Åª¬π‚Åπ) = 0.0259 eV ‚âà 0.026 eV"
                },
                {
                    question: "Calculate the drift velocity of electrons in silicon with mobility Œº = 1400 cm¬≤/V‚ãÖs under an electric field of 1000 V/cm.",
                    answer: 1.4e7,
                    unit: "cm/s",
                    tolerance: 1e6,
                    solution: "vd = ŒºE = 1400 cm¬≤/V‚ãÖs √ó 1000 V/cm = 1.4 √ó 10‚Å∑ cm/s"
                },
                {
                    question: "For a quantum well of width 10 nm, calculate the first energy level (n=1) for electrons. Use m* = 0.067m‚ÇÄ and assume infinite barriers. (Use ‚Ñè¬≤œÄ¬≤/2m‚ÇÄ = 3.81 eV‚ãÖ√Ö¬≤)",
                    answer: 0.57,
                    unit: "eV",
                    tolerance: 0.05,
                    solution: "E‚ÇÅ = œÄ¬≤‚Ñè¬≤/(2m*L¬≤) = (3.81 eV‚ãÖ√Ö¬≤)/(0.067 √ó (100 √Ö)¬≤) = 0.57 eV"
                },
                {
                    question: "Calculate the density of states at the conduction band edge for GaAs at 300K. Use m* = 0.067m‚ÇÄ and the formula g(E) = (1/2œÄ¬≤)(2m*/‚Ñè¬≤)^(3/2)‚àöE with ‚Ñè¬≤/2m‚ÇÄ = 3.81 eV‚ãÖ√Ö¬≤. Answer in units of 10¬π‚Å∏ cm‚Åª¬≥‚ãÖeV‚Åª¬π.",
                    answer: 2.84,
                    unit: "√ó10¬π‚Å∏ cm‚Åª¬≥‚ãÖeV‚Åª¬π",
                    tolerance: 0.3,
                    solution: "g(E) = (1/2œÄ¬≤)(2m*/‚Ñè¬≤)^(3/2)‚àöE = (1/2œÄ¬≤)(0.067/3.81√Ö‚Åª¬≤)^(3/2) √ó 10¬≤¬π √Ö‚Åª¬≥ = 2.84√ó10¬π‚Å∏ cm‚Åª¬≥‚ãÖeV‚Åª¬π"
                },
                {
                    question: "Calculate the diffusion length for electrons in silicon if the diffusion coefficient is 35 cm¬≤/s and the lifetime is 10 Œºs.",
                    answer: 187,
                    unit: "Œºm",
                    tolerance: 10,
                    solution: "Ln = ‚àö(Dn √ó œÑn) = ‚àö(35 cm¬≤/s √ó 10√ó10‚Åª‚Å∂ s) = ‚àö(3.5√ó10‚Åª‚Å¥) = 0.0187 cm = 187 Œºm"
                },
                {
                    question: "Find the built-in potential of a silicon PN junction with Na = 10¬π‚Å∂ cm‚Åª¬≥ and Nd = 10¬π‚Åµ cm‚Åª¬≥ at 300K. Use ni = 1.45√ó10¬π‚Å∞ cm‚Åª¬≥ and kBT/q = 0.026 V.",
                    answer: 0.635,
                    unit: "V",
                    tolerance: 0.05,
                    solution: "Vbi = (kBT/q) ln(NaNd/ni¬≤) = 0.026 √ó ln(10¬π‚Å∂√ó10¬π‚Åµ/(1.45√ó10¬π‚Å∞)¬≤) = 0.635 V"
                },
                {
                    question: "Calculate the depletion width of a one-sided PN junction (Na >> Nd) with Nd = 10¬π‚Åµ cm‚Åª¬≥ and Vbi = 0.7 V. Use Œµr = 11.7 and Œµ‚ÇÄ = 8.85√ó10‚Åª¬π‚Å¥ F/cm.",
                    answer: 0.95,
                    unit: "Œºm",
                    tolerance: 0.1,
                    solution: "W = ‚àö(2ŒµŒµoVbi/qNd) = ‚àö(2√ó11.7√ó8.85√ó10‚Åª¬π‚Å¥√ó0.7/(1.6√ó10‚Åª¬π‚Åπ√ó10¬π‚Åµ)) = 0.95 Œºm"
                }
            ],
            matching: [
                {
                    left: ["Direct Bandgap", "Effective Mass", "Mobility", "Drift Current", "Diffusion", "Quantum Well"],
                    right: ["Œº = qœÑ/m*", "Photon emission possible", "J = nqŒºE", "m* = ‚Ñè¬≤/(d¬≤E/dk¬≤)", "J = qD(dn/dx)", "Quantized energy levels"],
                    pairs: [[0,1], [1,3], [2,0], [3,2], [4,4], [5,5]],
                    explanations: {
                        0: "Direct bandgap semiconductors allow efficient photon emission because momentum is conserved in optical transitions",
                        1: "Effective mass is determined by the curvature of energy bands in k-space",
                        2: "Mobility relates to the scattering time and effective mass of carriers",
                        3: "Drift current results from carrier motion under an electric field",
                        4: "Diffusion current arises from concentration gradients",
                        5: "Quantum wells confine carriers leading to discrete energy states"
                    }
                },
                {
                    left: ["Avalanche Breakdown", "Zener Breakdown", "Tunneling", "Generation Current", "Recombination", "Surface States"],
                    right: ["Low voltage breakdown", "High field impact ionization", "Quantum mechanical process", "Interface traps", "Thermal equilibrium loss", "Dark current source"],
                    pairs: [[0,1], [1,0], [2,2], [3,5], [4,4], [5,3]],
                    explanations: {
                        0: "Avalanche breakdown occurs at high voltages due to impact ionization cascades",
                        1: "Zener breakdown occurs at low voltages via quantum tunneling",
                        2: "Tunneling is a quantum mechanical phenomenon where particles pass through energy barriers",
                        3: "Generation current contributes to leakage in reverse-biased junctions",
                        4: "Recombination processes help restore thermal equilibrium",
                        5: "Surface states at interfaces can trap carriers and affect device performance"
                    }
                }
            ],
            advanced: [
                {
                    question: "In a quantum well structure, what happens to the density of states?",
                    options: [
                        "It remains the same as bulk material",
                        "It becomes step-like due to 2D confinement",
                        "It increases exponentially",
                        "It becomes zero"
                    ],
                    correct: 1,
                    explanation: "In 2D systems (quantum wells), the density of states becomes step-like rather than the E^(1/2) dependence of 3D bulk materials.",
                    hint: "Think about how dimensionality affects the density of states"
                },
                {
                    question: "What is the primary advantage of using strained semiconductors?",
                    options: [
                        "Increased thermal conductivity",
                        "Modified band structure and mobility enhancement",
                        "Reduced manufacturing cost",
                        "Better chemical stability"
                    ],
                    correct: 1,
                    explanation: "Strain modifies the band structure, can split degeneracies, and often leads to enhanced carrier mobility by reducing scattering.",
                    hint: "Strain changes the crystal structure and thus the electronic properties"
                },
                {
                    question: "In a heterostructure, what determines the band lineup?",
                    options: [
                        "Only the bandgap difference",
                        "Electron affinity and bandgap differences",
                        "Only the lattice constant mismatch",
                        "The doping concentrations"
                    ],
                    correct: 1,
                    explanation: "Band lineup is determined by electron affinities (conduction band) and bandgap differences (valence band alignment).",
                    hint: "Consider what determines where the bands align at the interface"
                },
                {
                    question: "What is the main challenge in growing lattice-mismatched heterostructures?",
                    options: [
                        "Chemical incompatibility",
                        "Dislocation formation and strain relaxation",
                        "Different thermal expansion",
                        "Electron tunneling"
                    ],
                    correct: 1,
                    explanation: "Lattice mismatch creates strain, which if too large, relaxes through dislocation formation that degrades electrical properties.",
                    hint: "Think about what happens when you try to grow different lattice parameters together"
                },
                {
                    question: "In a MOSFET, what effect does channel length modulation have?",
                    options: [
                        "It decreases the threshold voltage",
                        "It causes finite output conductance in saturation",
                        "It increases the gate capacitance",
                        "It reduces the mobility"
                    ],
                    correct: 1,
                    explanation: "Channel length modulation causes the effective channel length to decrease with increasing VDS, leading to finite output conductance.",
                    hint: "Consider how the depletion region at the drain affects the channel"
                },
                {
                    question: "What is the primary mechanism behind hot carrier effects?",
                    options: [
                        "Thermal heating of the device",
                        "High energy carriers causing impact ionization",
                        "Increased doping concentration",
                        "Quantum tunneling through the gate"
                    ],
                    correct: 1,
                    explanation: "Hot carriers are high-energy carriers that can cause impact ionization and injection into the gate oxide, degrading device performance.",
                    hint: "Think about what happens to carriers in high electric fields"
                },
                {
                    question: "In band-to-band tunneling, what determines the tunneling probability?",
                    options: [
                        "Only the electric field strength",
                        "The bandgap and electric field",
                        "Only the effective mass",
                        "The doping concentration only"
                    ],
                    correct: 1,
                    explanation: "Tunneling probability depends exponentially on both the barrier width (related to bandgap) and height, as well as the electric field.",
                    hint: "Consider the WKB approximation for quantum tunneling"
                }
            ]
        };

        // Initialize the experiment
        function init() {
            updateMaterialInfo();
            plotEkDiagram();
            updatePhysicsValues();
            setupEventListeners();
            
            // Initialize all visualizations
            initializeCarrierTransport();
            initializeTemperatureAnalysis();
            
            // Ensure temperature controls are properly initialized
            document.getElementById('tempSlider').value = 300;
            document.getElementById('rangeSlider').value = 600;
            updateTemperatureProperties();

            // Initialize challenges
            initializeChallenges();
        }

        function setupEventListeners() {
            document.getElementById('materialSelect').addEventListener('change', handleMaterialChange);
            document.getElementById('kValue').addEventListener('input', handleKChange);
            document.getElementById('temperatureSlider').addEventListener('input', handleTemperatureChange);
            document.getElementById('dopingSlider').addEventListener('input', handleDopingChange);
            
            // Transport controls
            document.getElementById('electricField').addEventListener('input', updateTransportProperties);
            document.getElementById('mobility').addEventListener('input', updateTransportProperties);
            document.getElementById('carrierDensitySlider').addEventListener('input', updateTransportProperties);
            
            // Temperature controls - make sure both sliders are connected
            document.getElementById('tempSlider').addEventListener('input', updateTemperatureProperties);
            document.getElementById('rangeSlider').addEventListener('input', updateTemperatureRange);
        }

        function switchTab(tabButton, tabName) {
            document.querySelectorAll('.experiment-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            tabButton.classList.add('active');
            currentTab = tabName;
            
            // Initialize tab-specific content
            setTimeout(() => { // Small delay to ensure DOM is ready
                switch(tabName) {
                    case 'bandstructure':
                        plotEkDiagram();
                        break;
                    case 'transport':
                        updateTransportVisualization();
                        break;
                    case 'temperature':
                        updateTemperatureProperties();
                        if (typeof updateTemperatureVisualization === 'function') {
                            updateTemperatureVisualization();
                        }
                        break;
                    case 'challenges':
                        // Challenges are already initialized, just update stats
                        updateChallengeStats();
                        break;
                }
            }, 100);
        }

        function handleMaterialChange(event) {
            currentMaterial = event.target.value;
            updateMaterialInfo();
            plotEkDiagram();
            updatePhysicsValues();
            updateAllVisualizations();
        }

        function handleKChange(event) {
            currentK = parseFloat(event.target.value);
            document.getElementById('kDisplay').textContent = currentK.toFixed(2);
            updatePhysicsValues();
            highlightPoint();
        }

        function handleTemperatureChange(event) {
            const temp = parseFloat(event.target.value);
            document.getElementById('tempDisplay').textContent = temp;
            updatePhysicsValues();
            updateTemperatureIndicator(temp);
            // Redraw the graph with new temperature
            plotEkDiagram();
        }

        function handleDopingChange(event) {
            const doping = parseFloat(event.target.value);
            document.getElementById('dopingDisplay').textContent = `10${formatSuperscript(doping)}`;
            updatePhysicsValues();
            // Redraw the graph with new doping
            plotEkDiagram();
        }

        function updateTemperatureIndicator(temp) {
            const indicator = document.getElementById('tempIndicator');
            if (temp < 100) {
                indicator.className = 'temperature-indicator temp-cold';
                indicator.textContent = 'Cryogenic';
            } else if (temp <= 350) {
                indicator.className = 'temperature-indicator temp-room';
                indicator.textContent = 'Room Temp';
            } else {
                indicator.className = 'temperature-indicator temp-hot';
                indicator.textContent = 'High Temp';
            }
        }

        function applyMaterialPreset(materialKey) {
            currentMaterial = materialKey;
            document.getElementById('materialSelect').value = materialKey;
            updateMaterialInfo();
            plotEkDiagram();
            updatePhysicsValues();
            updateAllVisualizations();
        }

        function updateMaterialInfo() {
            const material = materials[currentMaterial];
            document.getElementById('materialName').textContent = material.name;
            
            const propertiesHtml = `
                <p style="margin: 4px 0;"><strong>Bandgap:</strong> ${material.bandgap} eV</p>
                <p style="margin: 4px 0;"><strong>Crystal:</strong> ${material.crystalStructure}</p>
                <p style="margin: 4px 0;"><strong>Electron m*:</strong> ${material.effectiveMassElectron} m<sub>0</sub></p>
                <p style="margin: 4px 0;"><strong>Hole m*:</strong> ${material.effectiveMassHole} m<sub>0</sub></p>
                <p style="margin: 4px 0;"><strong>Mobility (e<sup>-</sup>):</strong> ${material.mobility_e} cm<sup>2</sup>/V¬∑s</p>
                <p style="margin: 4px 0;"><strong>Mobility (h<sup>+</sup>):</strong> ${material.mobility_h} cm<sup>2</sup>/V¬∑s</p>
                <p style="margin: 4px 0;"><strong>Dielectric:</strong> ${material.dielectric}</p>
                <p style="font-style: italic; margin: 8px 0 4px 0; color: #6b7280; font-size: 0.8rem;">${material.description}</p>
            `;
            document.getElementById('materialProperties').innerHTML = propertiesHtml;
        }

        function plotEkDiagram() {
            const material = materials[currentMaterial];
            const temperature = parseFloat(document.getElementById('temperatureSlider').value) || 300;
            const doping = Math.pow(10, parseFloat(document.getElementById('dopingSlider').value) || 15);
            
            // Generate k values
            const kValues = [];
            const energiesConductionBand = [];
            const energiesValenceBand = [];
            const fermiLevel = [];
            const electronsValence = [];
            const electronsConduction = [];
            
            // Calculate temperature-dependent bandgap
            const Eg = material.bandgap + material.bandgapTemp * (temperature - 300);
            
            // Calculate Fermi level
            const ni = material.ni_300 * Math.pow(temperature/300, 1.5) * Math.exp(-Eg * eV / (2 * kB * temperature));
            const Ef = Eg/2 + (kB * temperature / eV) * Math.log(doping / ni);
            
            // Fermi-Dirac distribution function
            function fermiDirac(E, Ef, T) {
                const kT = kB * T / eV; // in eV
                return 1 / (1 + Math.exp((E - Ef) / kT));
            }
            
            for (let k = -3; k <= 3; k += 0.02) {
                kValues.push(k);
                
                // Enhanced parabolic band approximation with non-parabolicity
                const kSI = k * 1e9; // Convert to SI units
                const Ek_c = Eg/2 + (hbar * hbar * kSI * kSI) / (2 * material.effectiveMassElectron * m0 * eV);
                const Ek_v = -Eg/2 - (hbar * hbar * kSI * kSI) / (2 * material.effectiveMassHole * m0 * eV);
                
                // Add non-parabolicity for GaAs and other direct bandgap semiconductors
                let nonParabolicityFactor = 1;
                if (currentMaterial === 'gaas' || currentMaterial === 'inp') {
                    nonParabolicityFactor = 1 + 0.05 * Math.abs(k);
                }
                
                const E_c = Ek_c * nonParabolicityFactor;
                const E_v = Ek_v;
                
                energiesConductionBand.push(E_c);
                energiesValenceBand.push(E_v);
                fermiLevel.push(Ef);
                
                // Calculate electron occupation probability
                const prob_valence = fermiDirac(E_v, Ef, temperature);
                const prob_conduction = fermiDirac(E_c, Ef, temperature);
                
                // Create filled states visualization
                // Valence band: mostly filled (especially at T=0)
                electronsValence.push(E_v - 0.1 + (1 - prob_valence) * 0.1); // Holes appear as "empty" states
                
                // Conduction band: mostly empty, some electrons at higher T
                electronsConduction.push(E_c + 0.1 - prob_conduction * 0.1);
            }

            // Main band structure
            const trace1 = {
                x: kValues,
                y: energiesConductionBand,
                type: 'scatter',
                mode: 'lines',
                name: 'Conduction Band',
                line: { color: '#1f77b4', width: 3 }
            };

            const trace2 = {
                x: kValues,
                y: energiesValenceBand,
                type: 'scatter',
                mode: 'lines',
                name: 'Valence Band',
                line: { color: '#ff7f0e', width: 3 }
            };

            // Fermi level
            const trace3 = {
                x: kValues,
                y: fermiLevel,
                type: 'scatter',
                mode: 'lines',
                name: 'Fermi Level',
                line: { color: '#d62728', width: 2, dash: 'dash' }
            };

            // Electron occupation in valence band (filled states)
            const trace4 = {
                x: kValues,
                y: energiesValenceBand,
                type: 'scatter',
                mode: 'none',
                name: 'Filled Valence States',
                fill: 'tonexty',
                fillcolor: 'rgba(255, 127, 14, 0.6)',
                showlegend: true,
                y2: electronsValence
            };

            // Electron occupation in conduction band
            const conductionElectrons = kValues.map((k, i) => {
                const E_c = energiesConductionBand[i];
                const prob = fermiDirac(E_c, Ef, temperature);
                return prob > 0.01 ? E_c : null; // Only show significant occupation
            });

            const trace5 = {
                x: kValues,
                y: conductionElectrons,
                type: 'scatter',
                mode: 'markers',
                name: 'Conduction Electrons',
                marker: { 
                    color: '#2ca02c', 
                    size: 4,
                    opacity: 0.7
                },
                showlegend: true
            };

            // Valence band filled states (blue dots representing electrons)
            const valenceFilled = [];
            const valenceFilled_k = [];
            
            for (let i = 0; i < kValues.length; i += 5) { // Sample every 5th point
                const k = kValues[i];
                const E_v = energiesValenceBand[i];
                const prob = fermiDirac(E_v, Ef, temperature);
                
                if (prob > 0.5) { // Mostly filled
                    valenceFilled.push(E_v);
                    valenceFilled_k.push(k);
                }
            }

            const trace6 = {
                x: valenceFilled_k,
                y: valenceFilled,
                type: 'scatter',
                mode: 'markers',
                name: 'Valence Electrons',
                marker: { 
                    color: '#ff7f0e', 
                    size: 3,
                    opacity: 0.8
                },
                showlegend: true
            };

            const layout = {
                title: `E-k Diagram: ${material.name} at ${temperature}K<br><sub>Blue dots: conduction electrons, Orange: valence electrons</sub>`,
                xaxis: {
                    title: 'k-vector (1/m √ó 10‚Åπ)',
                    gridcolor: '#e5e7eb',
                    zeroline: true,
                    zerolinecolor: '#374151'
                },
                yaxis: {
                    title: 'Energy (eV)',
                    gridcolor: '#e5e7eb',
                    zeroline: true,
                    zerolinecolor: '#374151'
                },
                plot_bgcolor: '#ffffff',
                paper_bgcolor: '#ffffff',
                font: { family: 'Poppins, sans-serif' },
                showlegend: true,
                hovermode: 'closest',
                annotations: [
                    {
                        x: 0,
                        y: Eg,
                        text: `Eg = ${Eg.toFixed(3)} eV`,
                        showarrow: true,
                        arrowhead: 2,
                        arrowsize: 1,
                        arrowwidth: 2,
                        arrowcolor: '#6366f1'
                    },
                    {
                        x: 2,
                        y: Ef,
                        text: `EF = ${Ef.toFixed(3)} eV`,
                        showarrow: true,
                        arrowhead: 2,
                        arrowsize: 1,
                        arrowwidth: 2,
                        arrowcolor: '#d62728'
                    }
                ]
            };

            const config = {
                responsive: true,
                displayModeBar: false
            };

            // Plot with electron occupation visualization
            const traces = [trace1, trace2, trace3, trace6];
            
            // Add conduction electrons only if temperature is high enough or heavily doped
            if (temperature > 200 || doping > 1e16) {
                traces.push(trace5);
            }
            
            // Add animated electron transition markers during animation
            if (animationRunning) {
                const transitionElectrons = [];
                const transitionElectrons_k = [];
                
                // Create animated electrons showing transitions
                const time = Date.now() * 0.002;
                for (let i = 0; i < 8; i++) {
                    const phase = (i / 8) * 2 * Math.PI + time;
                    const k = 1.5 * Math.sin(phase);
                    const kSI = k * 1e9;
                    
                    // Calculate energy levels
                    const E_v = -Eg/2 - (hbar * hbar * kSI * kSI) / (2 * material.effectiveMassHole * m0 * eV);
                    const E_c = Eg/2 + (hbar * hbar * kSI * kSI) / (2 * material.effectiveMassElectron * m0 * eV);
                    
                    // Animate electron excitation (transition from valence to conduction)
                    const excitationProgress = (Math.sin(time + i * 0.5) + 1) / 2; // 0 to 1
                    const electronEnergy = E_v + (E_c - E_v) * excitationProgress;
                    
                    transitionElectrons.push(electronEnergy);
                    transitionElectrons_k.push(k);
                }
                
                const transitionTrace = {
                    x: transitionElectrons_k,
                    y: transitionElectrons,
                    type: 'scatter',
                    mode: 'markers',
                    name: 'Transitioning Electrons',
                    marker: { 
                        color: '#10b981',
                        size: 8,
                        opacity: 0.9,
                        symbol: 'circle',
                        line: { color: 'white', width: 1 }
                    },
                    showlegend: true
                };
                
                traces.push(transitionTrace);
            }

            Plotly.newPlot('ekChart', traces, layout, config);
            
            // Add click event listener
            document.getElementById('ekChart').on('plotly_click', function(data) {
                if (data.points.length > 0) {
                    const point = data.points[0];
                    currentK = point.x;
                    document.getElementById('kValue').value = currentK;
                    document.getElementById('kDisplay').textContent = currentK.toFixed(2);
                    updatePhysicsValues();
                    highlightPoint();
                }
            });
            
            highlightPoint();
        }

        function highlightPoint() {
            const material = materials[currentMaterial];
            const temperature = parseFloat(document.getElementById('temperatureSlider').value) || 300;
            const kSI = currentK * 1e9;
            
            // Calculate temperature-dependent bandgap
            const Eg = material.bandgap + material.bandgapTemp * (temperature - 300);
            
            // Calculate energies for current k
            const energyConduction = Eg/2 + (hbar * hbar * kSI * kSI) / (2 * material.effectiveMassElectron * m0 * eV);
            const energyValence = -Eg/2 - (hbar * hbar * kSI * kSI) / (2 * material.effectiveMassHole * m0 * eV);

            // Remove existing selected point traces
            const plotElement = document.getElementById('ekChart');
            if (plotElement.data && plotElement.data.length > 3) {
                // Remove all traces beyond the first 3 (conduction, valence, fermi)
                const tracesToDelete = [];
                for (let i = 3; i < plotElement.data.length; i++) {
                    tracesToDelete.push(i);
                }
                if (tracesToDelete.length > 0) {
                    Plotly.deleteTraces('ekChart', tracesToDelete);
                }
            }

            // Add new point markers
            const pointTrace = {
                x: [currentK, currentK],
                y: [energyConduction, energyValence],
                type: 'scatter',
                mode: 'markers',
                name: 'Selected Points',
                marker: { 
                    color: '#2ca02c', 
                    size: 12,
                    symbol: 'circle',
                    line: { color: 'white', width: 2 }
                },
                showlegend: false
            };

            Plotly.addTraces('ekChart', [pointTrace]);
            
            // Update point info
            const pointInfoHtml = `
                <p><strong>k:</strong> ${currentK.toFixed(3)} √ó 10<sup>9</sup> m<sup>-1</sup></p>
                <p><strong>E<sub>c</sub>:</strong> ${energyConduction.toFixed(3)} eV</p>
                <p><strong>E<sub>v</sub>:</strong> ${energyValence.toFixed(3)} eV</p>
                <p><strong>ŒîE:</strong> ${(energyConduction - energyValence).toFixed(3)} eV</p>
            `;
            document.getElementById('pointDetails').innerHTML = pointInfoHtml;
        }

        function updatePhysicsValues() {
            const material = materials[currentMaterial];
            const temperature = parseFloat(document.getElementById('temperatureSlider').value) || 300;
            const doping = Math.pow(10, parseFloat(document.getElementById('dopingSlider').value) || 15);
            const kSI = currentK * 1e9;
            
            // Temperature-dependent properties
            const Eg = material.bandgap + material.bandgapTemp * (temperature - 300);
            const ni = material.ni_300 * Math.pow(temperature/300, 1.5) * Math.exp(-Eg * eV / (2 * kB * temperature));
            
            // Group velocity: v_g = (1/‚Ñè) √ó dE/dk
            const groupVelocityConduction = (hbar * kSI) / (material.effectiveMassElectron * m0);
            const groupVelocityValence = -(hbar * kSI) / (material.effectiveMassHole * m0);
            
            const groupVelocity = Math.abs(currentK) > 0 ? 
                (currentK > 0 ? groupVelocityConduction : Math.abs(groupVelocityValence)) : 0;
            
            // Crystal momentum: p = ‚Ñèk
            const momentum = hbar * kSI;
            
            // Effective mass (use conduction band for positive k, valence for negative)
            const effectiveMass = currentK >= 0 ? 
                material.effectiveMassElectron : material.effectiveMassHole;
            
            // Fermi level calculation
            const Ef = Eg/2 + (kB * temperature / eV) * Math.log(doping / ni);
            
            // Update displays
            document.getElementById('groupVelocity').textContent = (groupVelocity / 1e5).toFixed(2);
            document.getElementById('momentum').textContent = (momentum / 1e-24).toFixed(2);
            document.getElementById('effectiveMass').textContent = effectiveMass.toFixed(3);
            document.getElementById('bandgap').textContent = Eg.toFixed(3);
            document.getElementById('carrierDensity').textContent = formatScientific(ni);
            document.getElementById('fermiLevel').textContent = Ef.toFixed(3);
        }

        // Advanced Carrier Transport Simulation
        let carriers = [];
        let carrierIdCounter = 0;
        let recombinationEvents = [];
        
        function initializeCarrierTransport() {
            const carrierField = document.getElementById('carrierField');
            const trajectoryLayer = document.getElementById('trajectoryLayer');
            const latticeBackground = document.getElementById('latticeBackground');
            
            // Clear existing elements
            carrierField.innerHTML = '';
            trajectoryLayer.innerHTML = '';
            carriers = [];
            
            // Create crystal lattice visualization
            createLatticeBackground();
            
            // Create carriers with physics properties
            for (let i = 0; i < 20; i++) {
                createAdvancedCarrier('electron');
                createAdvancedCarrier('hole');
            }
            
            updateTransportProperties();
            updateTransportInfo();
        }

        function createLatticeBackground() {
            const latticeBackground = document.getElementById('latticeBackground');
            latticeBackground.innerHTML = '';
            
            // Create a simple crystal lattice pattern
            for (let x = 0; x < 100; x += 15) {
                for (let y = 0; y < 100; y += 15) {
                    const latticePoint = document.createElement('div');
                    latticePoint.style.position = 'absolute';
                    latticePoint.style.left = x + '%';
                    latticePoint.style.top = y + '%';
                    latticePoint.style.width = '2px';
                    latticePoint.style.height = '2px';
                    latticePoint.style.background = '#94a3b8';
                    latticePoint.style.borderRadius = '50%';
                    latticeBackground.appendChild(latticePoint);
                }
            }
        }

        function createAdvancedCarrier(type) {
            const carrierField = document.getElementById('carrierField');
            const carrier = document.createElement('div');
            
            const carrierId = carrierIdCounter++;
            const x = Math.random() * 95;
            const y = Math.random() * 95;
            
            carrier.className = `carrier-dot ${type}`;
            carrier.style.left = x + '%';
            carrier.style.top = y + '%';
            carrier.id = `carrier-${carrierId}`;
            
            // Add physics properties
            const carrierData = {
                id: carrierId,
                type: type,
                x: x,
                y: y,
                vx: (Math.random() - 0.5) * 2, // Initial thermal velocity
                vy: (Math.random() - 0.5) * 2,
                energy: 0.025 + Math.random() * 0.1, // eV
                lifetime: 1000 + Math.random() * 2000, // frames
                age: 0,
                element: carrier
            };
            
            carriers.push(carrierData);
            carrierField.appendChild(carrier);
            
            // Add click event for carrier information
            carrier.addEventListener('click', () => showCarrierInfo(carrierData));
        }

        function showCarrierInfo(carrier) {
            const material = materials[currentMaterial];
            const field = parseFloat(document.getElementById('electricField').value);
            const mobility = parseFloat(document.getElementById('mobility').value);
            
            const info = `
                <strong>${carrier.type.toUpperCase()} #${carrier.id}</strong><br>
                Position: (${carrier.x.toFixed(1)}%, ${carrier.y.toFixed(1)}%)<br>
                Velocity: ${Math.sqrt(carrier.vx * carrier.vx + carrier.vy * carrier.vy).toFixed(2)} units<br>
                Energy: ${carrier.energy.toFixed(3)} eV<br>
                Age: ${carrier.age} frames<br>
                Mobility: ${mobility} cm¬≤/V‚ãÖs
            `;
            
            // Show tooltip
            showTooltip(carrier.element, info);
        }

        function showTooltip(element, content) {
            // Remove existing tooltips
            document.querySelectorAll('.carrier-tooltip').forEach(t => t.remove());
            
            const tooltip = document.createElement('div');
            tooltip.className = 'carrier-tooltip';
            tooltip.innerHTML = content;
            tooltip.style.cssText = `
                position: absolute;
                background: rgba(0,0,0,0.9);
                color: white;
                padding: 8px;
                border-radius: 4px;
                font-size: 11px;
                z-index: 20;
                pointer-events: none;
                max-width: 200px;
            `;
            
            const rect = element.getBoundingClientRect();
            const container = document.getElementById('transportContainer').getBoundingClientRect();
            
            tooltip.style.left = (rect.left - container.left + 15) + 'px';
            tooltip.style.top = (rect.top - container.top - 30) + 'px';
            
            document.getElementById('transportContainer').appendChild(tooltip);
            
            setTimeout(() => tooltip.remove(), 3000);
        }

        function startCarrierAnimation() {
            if (carrierAnimationRunning) return;
            carrierAnimationRunning = true;
            
            document.getElementById('transportStatus').textContent = '‚ñ∂ Simulation Running';
            document.getElementById('fieldIndicator').style.display = 'block';
            
            animateCarriers();
        }

        function pauseCarrierAnimation() {
            carrierAnimationRunning = false;
            document.getElementById('transportStatus').textContent = '‚è∏ Simulation Paused';
            document.getElementById('fieldIndicator').style.display = 'none';
        }

        function resetCarrierAnimation() {
            carrierAnimationRunning = false;
            document.getElementById('transportStatus').textContent = 'üîÑ Resetting...';
            setTimeout(() => {
                initializeCarrierTransport();
                document.getElementById('transportStatus').textContent = '‚è∏ Simulation Reset';
            }, 500);
        }

        function animateCarriers() {
            if (!carrierAnimationRunning) return;
            
            const field = parseFloat(document.getElementById('electricField').value);
            const mobility = parseFloat(document.getElementById('mobility').value) / 1000; // Scale for animation
            const temperature = parseFloat(document.getElementById('temperatureSlider')?.value) || 300;
            
            // Physics calculations
            const thermalVelocity = Math.sqrt(temperature / 300) * 0.5;
            const driftVelocity = mobility * field / 1000;
            
            carriers.forEach((carrier, index) => {
                carrier.age++;
                
                // Thermal motion (diffusion)
                const thermalX = (Math.random() - 0.5) * thermalVelocity;
                const thermalY = (Math.random() - 0.5) * thermalVelocity;
                
                // Drift motion (field effect)
                let driftX = 0;
                if (field > 0) {
                    driftX = carrier.type === 'electron' ? -driftVelocity : driftVelocity;
                }
                
                // Update velocity with momentum considerations
                carrier.vx = carrier.vx * 0.95 + driftX + thermalX; // Momentum damping
                carrier.vy = carrier.vy * 0.98 + thermalY;
                
                // Update position
                carrier.x += carrier.vx;
                carrier.y += carrier.vy;
                
                // Boundary conditions with periodic wrapping for x, reflection for y
                if (carrier.x < -2) carrier.x = 97;
                if (carrier.x > 97) carrier.x = -2;
                if (carrier.y < 0 || carrier.y > 95) {
                    carrier.vy = -carrier.vy * 0.8; // Reflection with energy loss
                    carrier.y = Math.max(0, Math.min(95, carrier.y));
                }
                
                // Update visual position
                carrier.element.style.left = carrier.x + '%';
                carrier.element.style.top = carrier.y + '%';
                
                // High field effects
                if (Math.abs(carrier.vx) > 2) {
                    carrier.element.classList.add('carrier-fast');
                } else {
                    carrier.element.classList.remove('carrier-fast');
                }
                
                // Check for recombination
                if (carrier.type === 'electron' && Math.random() < 0.001) {
                    checkRecombination(carrier, index);
                }
                
                // Carrier lifetime and regeneration
                if (carrier.age > carrier.lifetime) {
                    regenerateCarrier(carrier, index);
                }
            });
            
            // Update trajectories
            updateTrajectories();
            
            // Update physics info
            updateTransportInfo();
            
            requestAnimationFrame(animateCarriers);
        }

        function checkRecombination(electron, electronIndex) {
            // Find nearby holes for recombination
            const recombinationRadius = 5; // percentage units
            
            carriers.forEach((carrier, index) => {
                if (carrier.type === 'hole' && index !== electronIndex) {
                    const dx = electron.x - carrier.x;
                    const dy = electron.y - carrier.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < recombinationRadius && Math.random() < 0.3) {
                        // Create recombination event
                        createRecombinationEvent((electron.x + carrier.x) / 2, (electron.y + carrier.y) / 2);
                        
                        // Remove both carriers and create new ones elsewhere
                        regenerateCarrier(electron, electronIndex);
                        regenerateCarrier(carrier, index);
                    }
                }
            });
        }

        function createRecombinationEvent(x, y) {
            const recombinationLayer = document.getElementById('recombinationLayer');
            const flash = document.createElement('div');
            flash.className = 'recombination-flash';
            flash.style.left = x + '%';
            flash.style.top = y + '%';
            recombinationLayer.appendChild(flash);
            
            setTimeout(() => flash.remove(), 800);
        }

        function regenerateCarrier(carrier, index) {
            // Reset carrier properties for regeneration
            carrier.x = Math.random() * 95;
            carrier.y = Math.random() * 95;
            carrier.vx = (Math.random() - 0.5) * 2;
            carrier.vy = (Math.random() - 0.5) * 2;
            carrier.age = 0;
            carrier.lifetime = 1000 + Math.random() * 2000;
            
            // Update position
            carrier.element.style.left = carrier.x + '%';
            carrier.element.style.top = carrier.y + '%';
        }

        function updateTrajectories() {
            const trajectoryLayer = document.getElementById('trajectoryLayer');
            
            // Clear old trajectories periodically
            if (Math.random() < 0.1) {
                trajectoryLayer.innerHTML = '';
            }
            
            // Add new trajectory segments for fast-moving carriers
            carriers.forEach(carrier => {
                if (Math.abs(carrier.vx) > 1.5 || Math.abs(carrier.vy) > 1.5) {
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', (carrier.x - carrier.vx * 2) + '%');
                    line.setAttribute('y1', (carrier.y - carrier.vy * 2) + '%');
                    line.setAttribute('x2', carrier.x + '%');
                    line.setAttribute('y2', carrier.y + '%');
                    line.setAttribute('class', 'trajectory-line');
                    line.style.stroke = carrier.type === 'electron' ? 'rgba(59, 130, 246, 0.4)' : 'rgba(239, 68, 68, 0.4)';
                    trajectoryLayer.appendChild(line);
                }
            });
        }

        function updateTransportInfo() {
            const field = parseFloat(document.getElementById('electricField').value);
            const mobility = parseFloat(document.getElementById('mobility').value);
            
            // Determine dominant transport mechanism
            let dominantMechanism = 'Thermal Motion';
            if (field > 1000) {
                dominantMechanism = 'Strong Drift';
            } else if (field > 100) {
                dominantMechanism = 'Moderate Drift';
            } else if (field > 10) {
                dominantMechanism = 'Weak Drift + Diffusion';
            }
            
            document.getElementById('dominantMechanism').textContent = `Dominant: ${dominantMechanism}`;
            document.getElementById('fieldStrength').textContent = `Field: ${field} V/cm`;
        }

        function updateTransportProperties() {
            const material = materials[currentMaterial];
            const field = parseFloat(document.getElementById('electricField').value) || 0;
            const mobility = parseFloat(document.getElementById('mobility').value) || material.mobility_e;
            const density = Math.pow(10, parseFloat(document.getElementById('carrierDensitySlider').value) || 16);
            
            document.getElementById('fieldDisplay').textContent = field;
            document.getElementById('mobilityDisplay').textContent = mobility;
            document.getElementById('densityDisplay').textContent = `10${formatSuperscript(Math.log10(density).toFixed(1))}`;
            
            // Calculate transport properties
            const driftVelocity = mobility * field; // cm/s
            const conductivity = q * density * mobility * 1e-6; // S/cm (convert from S/m)
            const current = conductivity * field; // A/cm¬≤
            const resistivity = conductivity > 0 ? 1 / conductivity : Infinity; // Œ©‚ãÖcm
            
            // Diffusion properties
            const Dn = mobility * kB * 300 / q * 1e4; // cm¬≤/s (Einstein relation)
            const diffusionLength = Math.sqrt(Dn * 1e-6) * 1e6; // Œºm (assuming œÑ = 1Œºs)
            const meanFreePath = mobility * Math.sqrt(2 * m0 * kB * 300) / q * 1e9; // nm
            
            // Update display
            document.getElementById('driftVelocity').textContent = formatScientific(driftVelocity);
            document.getElementById('conductivity').textContent = conductivity.toExponential(2);
            document.getElementById('current').textContent = current.toExponential(2);
            document.getElementById('resistivity').textContent = resistivity.toExponential(2);
            document.getElementById('diffusionLength').textContent = diffusionLength.toFixed(1);
            document.getElementById('meanFreePath').textContent = meanFreePath.toFixed(1);
        }

        function applyTransportPreset(preset) {
            const material = materials[currentMaterial];
            
            switch(preset) {
                case 'drift':
                    document.getElementById('electricField').value = 1000;
                    document.getElementById('mobility').value = material.mobility_e;
                    break;
                case 'diffusion':
                    document.getElementById('electricField').value = 0;
                    document.getElementById('mobility').value = material.mobility_e;
                    break;
                case 'hot':
                    document.getElementById('electricField').value = 8000;
                    document.getElementById('mobility').value = material.mobility_e * 0.3;
                    break;
                case 'ballistic':
                    document.getElementById('electricField').value = 5000;
                    document.getElementById('mobility').value = material.mobility_e * 2;
                    break;
            }
            updateTransportProperties();
        }

        // Quantum Effects Simulation
        function initializeQuantumVisualization() {
            updateQuantumProperties();
        }

        function updateQuantumVisualization() {
            const width = parseFloat(document.getElementById('wellWidth').value) || 10;
            const height = parseFloat(document.getElementById('barrierHeight').value) || 0.3;
            const level = parseInt(document.getElementById('energyLevel').value) || 1;
            
            // Generate quantum well potential and wavefunctions
            const x = [];
            const potential = [];
            const wavefunction = [];
            const probability = [];
            
            for (let i = 0; i <= 200; i++) {
                const xi = i * 0.5 - 50; // nm
                x.push(xi);
                
                // Quantum well potential
                if (Math.abs(xi) <= width/2) {
                    potential.push(0);
                } else {
                    potential.push(height);
                }
                
                // Wavefunction (particle in a box approximation)
                let psi = 0;
                if (Math.abs(xi) <= width/2) {
                    psi = Math.sqrt(2/width) * Math.sin(level * Math.PI * (xi + width/2) / width);
                }
                
                const energy = level * level * Math.pow(hbar * Math.PI / (width * 1e-9), 2) / (2 * materials[currentMaterial].effectiveMassElectron * m0 * eV) * 1000; // meV
                
                wavefunction.push(psi * 0.1 + energy/1000);
                probability.push(psi * psi * 0.01 + energy/1000);
            }
            
            const trace1 = {
                x: x,
                y: potential,
                type: 'scatter',
                mode: 'lines',
                name: 'Potential Well',
                line: { color: '#1f77b4', width: 3 },
                fill: 'tozeroy',
                fillcolor: 'rgba(31, 119, 180, 0.3)'
            };
            
            const trace2 = {
                x: x,
                y: wavefunction,
                type: 'scatter',
                mode: 'lines',
                name: `œà(x) n=${level}`,
                line: { color: '#ff7f0e', width: 2 }
            };
            
            const trace3 = {
                x: x,
                y: probability,
                type: 'scatter',
                mode: 'lines',
                name: `|œà(x)|¬≤ n=${level}`,
                line: { color: '#2ca02c', width: 2 }
            };
            
            const layout = {
                title: `Quantum Well: ${width} nm wide, ${height} eV barrier`,
                xaxis: {
                    title: 'Position (nm)',
                    gridcolor: '#e5e7eb'
                },
                yaxis: {
                    title: 'Energy (eV)',
                    gridcolor: '#e5e7eb'
                },
                plot_bgcolor: '#ffffff',
                paper_bgcolor: '#ffffff',
                font: { family: 'Poppins, sans-serif' },
                showlegend: true
            };
            
            const config = {
                responsive: true,
                displayModeBar: false
            };
            
            Plotly.newPlot('quantumChart', [trace1, trace2, trace3], layout, config);
        }

        function updateQuantumProperties() {
            const width = parseFloat(document.getElementById('wellWidth').value) || 10;
            const height = parseFloat(document.getElementById('barrierHeight').value) || 0.3;
            const level = parseInt(document.getElementById('energyLevel').value) || 1;
            const material = materials[currentMaterial];
            
            document.getElementById('widthDisplay').textContent = width;
            document.getElementById('barrierDisplay').textContent = height.toFixed(2);
            document.getElementById('levelDisplay').textContent = `n=${level}`;
            
            // Calculate quantum properties
            const quantumEnergy = level * level * Math.pow(hbar * Math.PI / (width * 1e-9), 2) / (2 * material.effectiveMassElectron * m0 * eV) * 1000; // meV
            const confinementEnergy = quantumEnergy - (width > 50 ? 0 : quantumEnergy * 0.1); // Approximate
            
            // Tunneling probability (WKB approximation)
            const barrierWidth = 2; // nm
            const kappa = Math.sqrt(2 * material.effectiveMassElectron * m0 * height * eV) / hbar;
            const tunnelProb = Math.exp(-2 * kappa * barrierWidth * 1e-9) * 100; // %
            
            // de Broglie wavelength
            const momentum_quantum = Math.sqrt(2 * material.effectiveMassElectron * m0 * quantumEnergy/1000 * eV);
            const deBroglieLength = hbar / momentum_quantum * 1e9; // nm
            
            // Update display
            document.getElementById('quantumEnergy').textContent = quantumEnergy.toFixed(1);
            document.getElementById('confinementEnergy').textContent = confinementEnergy.toFixed(1);
            document.getElementById('tunnelProb').textContent = Math.min(100, tunnelProb).toFixed(3);
            document.getElementById('deBroglieLength').textContent = deBroglieLength.toFixed(2);
            
            updateQuantumVisualization();
        }

        function applyQuantumPreset(preset) {
            switch(preset) {
                case 'well':
                    document.getElementById('wellWidth').value = 10;
                    document.getElementById('barrierHeight').value = 0.3;
                    document.getElementById('energyLevel').value = 1;
                    break;
                case 'dot':
                    document.getElementById('wellWidth').value = 5;
                    document.getElementById('barrierHeight').value = 0.5;
                    document.getElementById('energyLevel').value = 1;
                    break;
                case 'wire':
                    document.getElementById('wellWidth').value = 2;
                    document.getElementById('barrierHeight').value = 0.4;
                    document.getElementById('energyLevel').value = 2;
                    break;
                case 'tunnel':
                    document.getElementById('wellWidth').value = 15;
                    document.getElementById('barrierHeight').value = 0.1;
                    document.getElementById('energyLevel').value = 1;
                    break;
            }
            updateQuantumProperties();
        }

        function toggleQuantumAnimation() {
            quantumAnimationRunning = !quantumAnimationRunning;
            if (quantumAnimationRunning) {
                animateQuantumWavefunction();
            }
        }

        function pauseQuantumAnimation() {
            quantumAnimationRunning = false;
        }

        function resetQuantumVisualization() {
            quantumAnimationRunning = false;
            updateQuantumVisualization();
        }

        function animateQuantumWavefunction() {
            if (!quantumAnimationRunning) return;
            
            // Phase evolution of wavefunction
            const currentLevel = parseInt(document.getElementById('energyLevel').value) || 1;
            const nextLevel = currentLevel >= 5 ? 1 : currentLevel + 1;
            document.getElementById('energyLevel').value = nextLevel;
            updateQuantumProperties();
            
            setTimeout(animateQuantumWavefunction, 1000);
        }

        // Temperature Analysis
        function initializeTemperatureAnalysis() {
            updateTemperatureProperties();
        }

        function updateTemperatureVisualization() {
            const material = materials[currentMaterial];
            const maxTemp = parseFloat(document.getElementById('rangeSlider').value) || 600;
            const currentTemp = parseFloat(document.getElementById('tempSlider').value) || 300;
            
            // Generate temperature sweep data
            const temperatures = [];
            const bandgaps = [];
            const intrinsicDensities = [];
            const mobilities = [];
            
            for (let T = 50; T <= maxTemp; T += 25) {
                temperatures.push(T);
                
                // Temperature-dependent bandgap (Varshni equation)
                const Eg = material.bandgap + material.bandgapTemp * (T - 300);
                bandgaps.push(Eg);
                
                // Intrinsic carrier density
                const ni = material.ni_300 * Math.pow(T/300, 1.5) * Math.exp(-Eg * eV / (2 * kB * T));
                intrinsicDensities.push(Math.log10(ni));
                
                // Temperature-dependent mobility (approximate T^-1.5 dependence)
                const mobility = material.mobility_e * Math.pow(300/T, 1.5);
                mobilities.push(mobility);
            }
            
            // Create separate subplots for different properties
            const trace1 = {
                x: temperatures,
                y: bandgaps,
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Bandgap (eV)',
                line: { color: '#1f77b4', width: 3 },
                marker: { size: 6 },
                xaxis: 'x',
                yaxis: 'y'
            };
            
            const trace2 = {
                x: temperatures,
                y: intrinsicDensities,
                type: 'scatter',
                mode: 'lines+markers',
                name: 'log‚ÇÅ‚ÇÄ(n·µ¢) [cm‚Åª¬≥]',
                line: { color: '#ff7f0e', width: 3 },
                marker: { size: 6 },
                xaxis: 'x2',
                yaxis: 'y2'
            };
            
            const trace3 = {
                x: temperatures,
                y: mobilities,
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Mobility (cm¬≤/V‚ãÖs)',
                line: { color: '#2ca02c', width: 3 },
                marker: { size: 6 },
                xaxis: 'x3',
                yaxis: 'y3'
            };
            
            // Add current temperature indicator
            const currentBandgap = material.bandgap + material.bandgapTemp * (currentTemp - 300);
            const currentNi = material.ni_300 * Math.pow(currentTemp/300, 1.5) * Math.exp(-currentBandgap * eV / (2 * kB * currentTemp));
            const currentMobility = material.mobility_e * Math.pow(300/currentTemp, 1.5);
            
            const currentPoint1 = {
                x: [currentTemp],
                y: [currentBandgap],
                type: 'scatter',
                mode: 'markers',
                name: 'Current T',
                marker: { color: '#d62728', size: 12, symbol: 'diamond' },
                xaxis: 'x',
                yaxis: 'y',
                showlegend: false
            };
            
            const currentPoint2 = {
                x: [currentTemp],
                y: [Math.log10(currentNi)],
                type: 'scatter',
                mode: 'markers',
                marker: { color: '#d62728', size: 12, symbol: 'diamond' },
                xaxis: 'x2',
                yaxis: 'y2',
                showlegend: false
            };
            
            const currentPoint3 = {
                x: [currentTemp],
                y: [currentMobility],
                type: 'scatter',
                mode: 'markers',
                marker: { color: '#d62728', size: 12, symbol: 'diamond' },
                xaxis: 'x3',
                yaxis: 'y3',
                showlegend: false
            };
            
            const layout = {
                title: {
                    text: `Temperature Analysis: ${material.name}`,
                    font: { size: 18 },
                    y: 0.98
                },
                grid: {
                    rows: 3,
                    columns: 1,
                    subplots: [['xy'], ['x2y2'], ['x3y3']],
                    roworder: 'top to bottom',
                    ygap: 0.08,  // Increased vertical spacing between subplots
                    pattern: 'independent'
                },
                
                // Bandgap subplot
                xaxis: {
                    title: '',
                    showticklabels: false,
                    gridcolor: '#e5e7eb',
                    domain: [0.1, 0.9]  // Add horizontal margins
                },
                yaxis: {
                    title: {
                        text: 'Bandgap (eV)',
                        font: { size: 14 }
                    },
                    titlefont: { color: '#1f77b4', size: 14 },
                    tickfont: { color: '#1f77b4', size: 12 },
                    gridcolor: '#e5e7eb',
                    domain: [0.72, 0.95]  // Top subplot with more space
                },
                
                // Intrinsic density subplot
                xaxis2: {
                    title: '',
                    showticklabels: false,
                    gridcolor: '#e5e7eb',
                    domain: [0.1, 0.9]
                },
                yaxis2: {
                    title: {
                        text: 'log‚ÇÅ‚ÇÄ(n·µ¢) [cm‚Åª¬≥]',
                        font: { size: 14 }
                    },
                    titlefont: { color: '#ff7f0e', size: 14 },
                    tickfont: { color: '#ff7f0e', size: 12 },
                    gridcolor: '#e5e7eb',
                    domain: [0.38, 0.62]  // Middle subplot with better spacing
                },
                
                // Mobility subplot
                xaxis3: {
                    title: {
                        text: 'Temperature (K)',
                        font: { size: 14 }
                    },
                    gridcolor: '#e5e7eb',
                    tickfont: { size: 12 },
                    domain: [0.1, 0.9]
                },
                yaxis3: {
                    title: {
                        text: 'Mobility (cm¬≤/V‚ãÖs)',
                        font: { size: 14 }
                    },
                    titlefont: { color: '#2ca02c', size: 14 },
                    tickfont: { color: '#2ca02c', size: 12 },
                    gridcolor: '#e5e7eb',
                    domain: [0.05, 0.28]  // Bottom subplot with more space
                },
                
                plot_bgcolor: '#ffffff',
                paper_bgcolor: '#ffffff',
                font: { family: 'Poppins, sans-serif', size: 12 },
                showlegend: true,
                legend: {
                    x: 1.02,  // Position to the right of the plot area
                    y: 0.8,   // Position in upper area
                    xanchor: 'left',  // Anchor to the left side of the legend
                    yanchor: 'top',   // Anchor to the top of the legend
                    bgcolor: 'rgba(255, 255, 255, 0.9)',
                    bordercolor: '#e5e7eb',
                    borderwidth: 1,
                    font: { size: 11 }  // Slightly smaller legend font
                },
                margin: {
                    l: 80,    // Left margin for y-axis titles
                    r: 160,   // Increased right margin for legend
                    t: 60,    // Top margin for title
                    b: 60     // Bottom margin for x-axis title
                },
                height: 650   // Increased height for better spacing
            };
            
            const config = {
                responsive: true,
                displayModeBar: false
            };
            
            const traces = [trace1, trace2, trace3, currentPoint1, currentPoint2, currentPoint3];
            
            Plotly.newPlot('temperatureChart', traces, layout, config);
        }

        function updateTemperatureProperties() {
            const material = materials[currentMaterial];
            const temperature = parseFloat(document.getElementById('tempSlider').value) || 300;
            
            document.getElementById('tempValue').textContent = temperature;
            document.getElementById('rangeValue').textContent = document.getElementById('rangeSlider').value + 'K';
            
            // Calculate temperature-dependent properties
            const Eg = material.bandgap + material.bandgapTemp * (temperature - 300);
            const ni = material.ni_300 * Math.pow(temperature/300, 1.5) * Math.exp(-Eg * eV / (2 * kB * temperature));
            const mobility = material.mobility_e * Math.pow(300/temperature, 1.5);
            const thermalVelocity = Math.sqrt(3 * kB * temperature / (material.effectiveMassElectron * m0)) * 100; // cm/s
            
            // Update displays
            document.getElementById('intrinsicDensity').textContent = formatScientific(ni);
            document.getElementById('bandgapTemp').textContent = Eg.toFixed(3);
            document.getElementById('mobilityTemp').textContent = mobility.toFixed(0);
            document.getElementById('thermalVelocity').textContent = formatScientific(thermalVelocity);
            
            updateTemperatureIndicator(temperature);
            
            if (currentTab === 'temperature') {
                // Small delay to ensure smooth updates
                setTimeout(() => {
                    updateTemperatureVisualization();
                }, 50);
            }
        }

        function setTemperature(temp) {
            document.getElementById('tempSlider').value = temp;
            updateTemperatureProperties();
            // Force update of visualization for preset buttons
            if (currentTab === 'temperature') {
                setTimeout(() => {
                    updateTemperatureVisualization();
                }, 100);
            }
        }

        function startTemperatureSweep() {
            if (temperatureSweepRunning) return;
            temperatureSweepRunning = true;
            sweepTemperature();
        }

        function pauseTemperatureSweep() {
            temperatureSweepRunning = false;
        }

        function resetTemperatureSweep() {
            temperatureSweepRunning = false;
            document.getElementById('tempSlider').value = 300;
            updateTemperatureProperties();
        }

        function sweepTemperature() {
            if (!temperatureSweepRunning) return;
            
            const currentTemp = parseFloat(document.getElementById('tempSlider').value);
            const maxTemp = parseFloat(document.getElementById('rangeSlider').value);
            
            let newTemp = currentTemp + 15;
            if (newTemp > maxTemp) {
                newTemp = 50; // Reset to minimum
            }
            
            document.getElementById('tempSlider').value = newTemp;
            updateTemperatureProperties();
            
            // Update the plot with new current temperature marker
            if (currentTab === 'temperature') {
                updateTemperatureVisualization();
            }
            
            setTimeout(sweepTemperature, 300);
        }

        function updateTemperatureRange() {
            const range = document.getElementById('rangeSlider').value;
            document.getElementById('rangeValue').textContent = range + 'K';
            if (currentTab === 'temperature') {
                // Delay to ensure the DOM is updated
                setTimeout(() => {
                    updateTemperatureVisualization();
                }, 50);
            }
        }

        // Animation Controls
        function toggleAnimation(experiment) {
            animationRunning = !animationRunning;
            
            // Update button text and state
            const button = document.querySelector(`button[onclick="toggleAnimation('${experiment}')"]`);
            if (animationRunning) {
                button.innerHTML = '‚è∏ Stop Transitions';
                button.classList.add('pause-btn');
                button.classList.remove('play-btn');
                
                switch(experiment) {
                    case 'bandstructure':
                        animateBandStructure();
                        break;
                }
            } else {
                button.innerHTML = '‚ñ∂ Show Electron Transitions';
                button.classList.add('play-btn');
                button.classList.remove('pause-btn');
                
                // Cancel any running animation
                if (animationId) {
                    cancelAnimationFrame(animationId);
                    animationId = null;
                }
            }
        }

        function pauseAnimation(experiment) {
            animationRunning = false;
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }
            
            // Hide animation status
            document.getElementById('animationStatus').style.display = 'none';
            
            // Reset button state
            const button = document.querySelector(`button[onclick="toggleAnimation('${experiment}')"]`);
            if (button) {
                button.innerHTML = '‚ñ∂ Show Electron Transitions';
                button.classList.add('play-btn');
                button.classList.remove('pause-btn');
            }
        }

        function resetVisualization(experiment) {
            animationRunning = false;
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }
            
            // Hide animation status
            document.getElementById('animationStatus').style.display = 'none';
            
            // Reset button state
            const button = document.querySelector(`button[onclick="toggleAnimation('${experiment}')"]`);
            if (button) {
                button.innerHTML = '‚ñ∂ Show Electron Transitions';
                button.classList.add('play-btn');
                button.classList.remove('pause-btn');
            }
            
            switch(experiment) {
                case 'bandstructure':
                    currentK = 0;
                    document.getElementById('kValue').value = 0;
                    document.getElementById('kDisplay').textContent = '0.00';
                    document.getElementById('temperatureSlider').value = 300;
                    document.getElementById('tempDisplay').textContent = '300';
                    updateTemperatureIndicator(300);
                    plotEkDiagram();
                    updatePhysicsValues();
                    break;
            }
        }

        function animateBandStructure() {
            if (!animationRunning) {
                document.getElementById('animationStatus').style.display = 'none';
                return;
            }
            
            // Show animation status
            const statusDiv = document.getElementById('animationStatus');
            const statusText = document.getElementById('animationStatusText');
            statusDiv.style.display = 'block';
            
            // Get current time for smooth animations
            const time = Date.now() * 0.001; // Convert to seconds
            
            // Alternate between temperature and k-vector animations
            const animationType = Math.floor(time / 8) % 2; // Switch every 8 seconds
            
            if (animationType === 0) {
                // Temperature animation - show thermal excitation of electrons
                statusText.innerHTML = 'üå°Ô∏è Sweeping temperature: thermal excitation of electrons';
                
                const baseTemp = 300;
                const tempVariation = 250 * Math.sin(time * 0.5); // Slower, smoother oscillation
                const newTemp = Math.max(50, Math.min(800, baseTemp + tempVariation));
                
                document.getElementById('temperatureSlider').value = newTemp;
                document.getElementById('tempDisplay').textContent = Math.round(newTemp);
                updateTemperatureIndicator(newTemp);
                
                // Force update of all temperature-dependent properties
                updatePhysicsValues();
                plotEkDiagram();
                
            } else {
                // k-vector sweep animation - show electron momentum states
                statusText.innerHTML = 'üîÑ Sweeping k-vector: exploring electron momentum states';
                
                const kRange = 2.5;
                const kSpeed = 0.8; // Faster k-vector sweep
                currentK = kRange * Math.sin(time * kSpeed);
                
                document.getElementById('kValue').value = currentK;
                document.getElementById('kDisplay').textContent = currentK.toFixed(2);
                
                // Update visualization
                updatePhysicsValues();
                highlightPoint();
            }
            
            // Continue animation loop
            animationId = requestAnimationFrame(animateBandStructure);
        }

        // Utility functions
        function formatSuperscript(value) {
            const superscripts = {
                '0': '‚Å∞', '1': '¬π', '2': '¬≤', '3': '¬≥', '4': '‚Å¥',
                '5': '‚Åµ', '6': '‚Å∂', '7': '‚Å∑', '8': '‚Å∏', '9': '‚Åπ',
                '.': '¬∑', '-': '‚Åª'
            };
            return value.toString().split('').map(char => superscripts[char] || char).join('');
        }

        function formatScientific(value) {
            if (value === 0) return '0';
            const exp = Math.floor(Math.log10(Math.abs(value)));
            const mantissa = value / Math.pow(10, exp);
            return `${mantissa.toFixed(2)}√ó10${formatSuperscript(exp)}`;
        }

        function updateAllVisualizations() {
            if (currentTab === 'transport') {
                updateTransportVisualization();
            } else if (currentTab === 'temperature') {
                updateTemperatureProperties();
                if (typeof updateTemperatureVisualization === 'function') {
                    updateTemperatureVisualization();
                }
            } else if (currentTab === 'bandstructure') {
                plotEkDiagram();
                updatePhysicsValues();
            }
        }

        function updateTransportVisualization() {
            initializeCarrierTransport();
            updateTransportProperties();
        }

        // Panel management
        function togglePanel(panelName) {
            const panel = document.getElementById(panelName + 'Panel');
            panel.classList.toggle('active');
            
            // Close other panels
            const allPanels = document.querySelectorAll('.floating-panel');
            allPanels.forEach(p => {
                if (p !== panel) {
                    p.classList.remove('active');
                }
            });
        }

        // Challenge System Functions
        function initializeChallenges() {
            // First, select random questions for this session
            selectRandomQuestions();
            
            // Then generate content using the selected questions
            generateQuizContent(1, selectedQuestions.bandStructure);
            generateAdvancedContent();
            generateFillBlanksContent();
            generateNumericalContent();
            generateMatchingContent();
            updateChallengeStats();
        }

        function generateQuizContent(challengeNum, questions) {
            const container = document.getElementById(`quiz${challengeNum}Content`);
            let html = '';
            
            questions.forEach((q, qIndex) => {
                html += `
                    <div class="quiz-question">
                        <h4>Question ${qIndex + 1}: ${q.question}</h4>
                        <div class="quiz-options">
                            ${q.options.map((option, oIndex) => `
                                <div class="quiz-option" onclick="selectQuizAnswer(${challengeNum}, ${qIndex}, ${oIndex}, this)">
                                    ${String.fromCharCode(65 + oIndex)}. ${option}
                                </div>
                            `).join('')}
                        </div>
                        <div class="explanation-panel" id="explanation_${challengeNum}_${qIndex}">
                            <div class="explanation-title">
                                <i class="fas fa-lightbulb"></i> Explanation
                            </div>
                            <div class="explanation-content">${q.explanation}</div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function generateAdvancedContent() {
            const container = document.getElementById('advancedContent');
            let html = '';
            
            selectedQuestions.advanced.forEach((q, qIndex) => {
                html += `
                    <div class="quiz-question">
                        <h4>Question ${qIndex + 1}: ${q.question}</h4>
                        <div class="quiz-options">
                            ${q.options.map((option, oIndex) => `
                                <div class="quiz-option" onclick="selectAdvancedAnswer(${qIndex}, ${oIndex}, this)">
                                    ${String.fromCharCode(65 + oIndex)}. ${option}
                                </div>
                            `).join('')}
                        </div>
                        <div class="explanation-panel" id="advanced_explanation_${qIndex}">
                            <div class="explanation-title">
                                <i class="fas fa-lightbulb"></i> Explanation
                            </div>
                            <div class="explanation-content">${q.explanation}</div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function generateFillBlanksContent() {
            const container = document.getElementById('fillBlanksContent');
            let html = '';
            
            selectedQuestions.fillBlanks.forEach((item, index) => {
                const parts = item.text.split('____');
                html += `
                    <div class="fill-blank-container">
                        <div class="fill-blank-text">
                            ${parts[0]}
                            <input type="text" class="fill-blank-input" id="blank_${index}" placeholder="?" data-answer="${item.answer}">
                            ${parts[1] || ''}
                        </div>
                        <div class="explanation-panel" id="fillblank_explanation_${index}">
                            <div class="explanation-title">
                                <i class="fas fa-lightbulb"></i> Hint
                            </div>
                            <div class="explanation-content">${item.hint}</div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function generateNumericalContent() {
            const container = document.getElementById('calculationContent');
            let html = '';
            
            selectedQuestions.numerical.forEach((problem, index) => {
                html += `
                    <div class="numerical-problem">
                        <h4>Problem ${index + 1}:</h4>
                        <p>${problem.question}</p>
                        <div style="margin: 15px 0;">
                            <strong>Answer:</strong>
                            <input type="number" step="any" class="numerical-input" id="numerical_${index}" 
                                   data-answer="${problem.answer}" data-tolerance="${problem.tolerance}">
                            <span class="unit-display">${problem.unit}</span>
                        </div>
                        <div class="explanation-panel" id="numerical_explanation_${index}">
                            <div class="explanation-title">
                                <i class="fas fa-calculator"></i> Solution
                            </div>
                            <div class="explanation-content">${problem.solution}</div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function generateMatchingContent() {
            const container = document.getElementById('matchingContent');
            const matching = selectedQuestions.matching[0];
            
            let html = `
                <div class="matching-container" id="matchingContainer">
                    <div class="matching-column">
                        <h4>Concepts</h4>
                        ${matching.left.map((item, index) => `
                            <div class="matching-item" data-type="left" data-index="${index}" onclick="selectMatchingItem(this)">
                                ${item}
                            </div>
                        `).join('')}
                    </div>
                    <div class="matching-column">
                        <h4>Definitions/Equations</h4>
                        ${matching.right.map((item, index) => `
                            <div class="matching-item" data-type="right" data-index="${index}" onclick="selectMatchingItem(this)">
                                ${item}
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div id="matchingInstructions" style="text-align: center; margin: 15px 0; color: #6b7280;">
                    Click on items from both columns to create matches. Click again to remove matches.
                </div>
            `;
            
            container.innerHTML = html;
        }

        function selectQuizAnswer(challengeNum, questionNum, answer, element) {
            // Remove previous selections
            const siblings = element.parentNode.querySelectorAll('.quiz-option');
            siblings.forEach(sib => {
                sib.classList.remove('selected');
            });
            
            // Add selection
            element.classList.add('selected');
            
            // Store answer
            if (!challengeAnswers[`quiz${challengeNum}`]) challengeAnswers[`quiz${challengeNum}`] = {};
            challengeAnswers[`quiz${challengeNum}`][questionNum] = answer;
        }

        function selectAdvancedAnswer(questionNum, answer, element) {
            // Remove previous selections
            const siblings = element.parentNode.querySelectorAll('.quiz-option');
            siblings.forEach(sib => {
                sib.classList.remove('selected');
            });
            
            // Add selection
            element.classList.add('selected');
            
            // Store answer
            challengeAnswers.advanced[questionNum] = answer;
        }

        let selectedMatchingItems = [];
        let matchingPairs = [];

        function selectMatchingItem(element) {
            if (element.classList.contains('matched')) return;
            
            if (element.classList.contains('selected')) {
                // Deselect
                element.classList.remove('selected');
                selectedMatchingItems = selectedMatchingItems.filter(item => item !== element);
            } else {
                // Select
                element.classList.add('selected');
                selectedMatchingItems.push(element);
                
                // If we have two items selected, create a pair
                if (selectedMatchingItems.length === 2) {
                    const [item1, item2] = selectedMatchingItems;
                    
                    // Make sure they're from different columns
                    if (item1.dataset.type !== item2.dataset.type) {
                        createMatchingPair(item1, item2);
                    }
                    
                    // Clear selections
                    selectedMatchingItems.forEach(item => item.classList.remove('selected'));
                    selectedMatchingItems = [];
                }
            }
        }

        function createMatchingPair(item1, item2) {
            item1.classList.add('matched');
            item2.classList.add('matched');
            
            const leftItem = item1.dataset.type === 'left' ? item1 : item2;
            const rightItem = item1.dataset.type === 'right' ? item1 : item2;
            
            matchingPairs.push({
                left: parseInt(leftItem.dataset.index),
                right: parseInt(rightItem.dataset.index),
                elements: [leftItem, rightItem]
            });
            
            // Add click handler to remove pair
            [leftItem, rightItem].forEach(el => {
                el.onclick = () => removeMatchingPair(leftItem, rightItem);
            });
        }

        function removeMatchingPair(leftItem, rightItem) {
            leftItem.classList.remove('matched');
            rightItem.classList.remove('matched');
            
            // Restore original click handlers
            leftItem.onclick = () => selectMatchingItem(leftItem);
            rightItem.onclick = () => selectMatchingItem(rightItem);
            
            // Remove from pairs array
            matchingPairs = matchingPairs.filter(pair => 
                !(pair.elements.includes(leftItem) && pair.elements.includes(rightItem))
            );
        }

        function showQuizHints(challengeNum) {
            const hint = document.getElementById(`challenge${challengeNum}Hint`);
            hint.classList.toggle('active');
            if (hint.classList.contains('active')) {
                hintsUsed++;
                updateChallengeStats();
            }
        }

        function showAdvancedHints() {
            const hint = document.getElementById('challenge2Hint');
            hint.classList.toggle('active');
            if (hint.classList.contains('active')) {
                hintsUsed++;
                updateChallengeStats();
            }
        }

        function showFillBlanksHint() {
            const hint = document.getElementById('challenge3Hint');
            hint.classList.toggle('active');
            if (hint.classList.contains('active')) {
                hintsUsed++;
                updateChallengeStats();
            }
        }

        function showCalculationHint() {
            const hint = document.getElementById('challenge4Hint');
            hint.classList.toggle('active');
            if (hint.classList.contains('active')) {
                hintsUsed++;
                updateChallengeStats();
            }
        }

        function showMatchingHints() {
            const hint = document.getElementById('challenge5Hint');
            hint.classList.toggle('active');
            if (hint.classList.contains('active')) {
                hintsUsed++;
                updateChallengeStats();
            }
        }

        function checkQuizAnswers(challengeNum) {
            const questions = challengeNum === 1 ? selectedQuestions.bandStructure : selectedQuestions.transport;
            const answers = challengeAnswers[`quiz${challengeNum}`];
            let score = 0;
            let total = questions.length;
            
            questions.forEach((q, index) => {
                const options = document.querySelectorAll(`#quiz${challengeNum}Content .quiz-question:nth-child(${index + 1}) .quiz-option`);
                const explanation = document.getElementById(`explanation_${challengeNum}_${index}`);
                
                options.forEach((option, oIndex) => {
                    option.classList.remove('correct', 'incorrect');
                    
                    if (oIndex === q.correct) {
                        option.classList.add('correct');
                    } else if (answers[index] === oIndex) {
                        option.classList.add('incorrect');
                    }
                });
                
                if (answers[index] === q.correct) {
                    score++;
                    correctAnswers++;
                }
                totalQuestions++;
                
                explanation.classList.add('active');
            });
            
            const percentage = Math.round((score / total) * 100);
            const feedback = document.getElementById(`challenge${challengeNum}Feedback`);
            
            if (score === total) {
                feedback.className = 'challenge-feedback success';
                feedback.innerHTML = `üéâ Perfect! You got all ${total} questions correct! (+${total * 20} points)`;
                challengeStates[challengeNum] = { completed: true, score: total * 20 };
                totalScore += total * 20;
                if (!challengeStates[challengeNum].completed) completedChallenges++;
            } else {
                feedback.className = 'challenge-feedback error';
                feedback.innerHTML = `You got ${score}/${total} correct (${percentage}%). Review the explanations and try again! (+${score * 10} points)`;
                challengeStates[challengeNum] = { completed: score > total/2, score: score * 10 };
                totalScore += score * 10;
            }
            
            feedback.style.display = 'block';
            updateChallengeStats();
            
            if (challengeStates[challengeNum].completed) {
                document.getElementById(`challenge${challengeNum}`).classList.add('completed');
            }
        }

        function checkAdvancedAnswers() {
            const questions = selectedQuestions.advanced;
            const answers = challengeAnswers.advanced;
            let score = 0;
            let total = questions.length;
            
            questions.forEach((q, index) => {
                const options = document.querySelectorAll(`#advancedContent .quiz-question:nth-child(${index + 1}) .quiz-option`);
                const explanation = document.getElementById(`advanced_explanation_${index}`);
                
                options.forEach((option, oIndex) => {
                    option.classList.remove('correct', 'incorrect');
                    
                    if (oIndex === q.correct) {
                        option.classList.add('correct');
                    } else if (answers[index] === oIndex) {
                        option.classList.add('incorrect');
                    }
                });
                
                if (answers[index] === q.correct) {
                    score++;
                    correctAnswers++;
                }
                totalQuestions++;
                
                explanation.classList.add('active');
            });
            
            const percentage = Math.round((score / total) * 100);
            const feedback = document.getElementById('challenge2Feedback');
            
            if (score === total) {
                feedback.className = 'challenge-feedback success';
                feedback.innerHTML = `üéâ Excellent! You got all ${total} advanced questions correct! (+${total * 25} points)`;
                challengeStates[2] = { completed: true, score: total * 25 };
                totalScore += total * 25;
                if (!challengeStates[2].completed) completedChallenges++;
            } else {
                feedback.className = 'challenge-feedback error';
                feedback.innerHTML = `You got ${score}/${total} correct (${percentage}%). Review the explanations and try again! (+${score * 12} points)`;
                challengeStates[2] = { completed: score > total/2, score: score * 12 };
                totalScore += score * 12;
            }
            
            feedback.style.display = 'block';
            updateChallengeStats();
            
            if (challengeStates[2].completed) {
                document.getElementById('challenge2').classList.add('completed');
            }
        }

        function checkFillBlanks() {
            const questions = selectedQuestions.fillBlanks;
            let score = 0;
            let total = questions.length;
            
            questions.forEach((item, index) => {
                const input = document.getElementById(`blank_${index}`);
                const userAnswer = input.value.trim().toLowerCase();
                const correctAnswer = item.answer.toLowerCase();
                const explanation = document.getElementById(`fillblank_explanation_${index}`);
                
                input.classList.remove('correct', 'incorrect');
                
                if (userAnswer === correctAnswer) {
                    input.classList.add('correct');
                    score++;
                    correctAnswers++;
                } else {
                    input.classList.add('incorrect');
                }
                
                totalQuestions++;
                explanation.classList.add('active');
            });
            
            const percentage = Math.round((score / total) * 100);
            const feedback = document.getElementById('challenge3Feedback');
            
            if (score === total) {
                feedback.className = 'challenge-feedback success';
                feedback.innerHTML = `üéâ Perfect! All blanks filled correctly! (+${total * 15} points)`;
                challengeStates[3] = { completed: true, score: total * 15 };
                totalScore += total * 15;
                if (!challengeStates[3].completed) completedChallenges++;
            } else {
                feedback.className = 'challenge-feedback error';
                feedback.innerHTML = `You got ${score}/${total} correct (${percentage}%). Check the hints and try again! (+${score * 8} points)`;
                challengeStates[3] = { completed: score > total/2, score: score * 8 };
                totalScore += score * 8;
            }
            
            feedback.style.display = 'block';
            updateChallengeStats();
            
            if (challengeStates[3].completed) {
                document.getElementById('challenge3').classList.add('completed');
            }
        }

        function checkCalculations() {
            const problems = selectedQuestions.numerical;
            let score = 0;
            let total = problems.length;
            
            problems.forEach((problem, index) => {
                const input = document.getElementById(`numerical_${index}`);
                const userAnswer = parseFloat(input.value);
                const correctAnswer = problem.answer;
                const tolerance = problem.tolerance;
                const explanation = document.getElementById(`numerical_explanation_${index}`);
                
                input.classList.remove('correct', 'incorrect');
                
                if (Math.abs(userAnswer - correctAnswer) <= tolerance) {
                    input.classList.add('correct');
                    score++;
                    correctAnswers++;
                } else {
                    input.classList.add('incorrect');
                }
                
                totalQuestions++;
                explanation.classList.add('active');
            });
            
            const percentage = Math.round((score / total) * 100);
            const feedback = document.getElementById('challenge4Feedback');
            
            if (score === total) {
                feedback.className = 'challenge-feedback success';
                feedback.innerHTML = `üéâ Outstanding! All calculations correct! (+${total * 30} points)`;
                challengeStates[4] = { completed: true, score: total * 30 };
                totalScore += total * 30;
                if (!challengeStates[4].completed) completedChallenges++;
            } else {
                feedback.className = 'challenge-feedback error';
                feedback.innerHTML = `You got ${score}/${total} correct (${percentage}%). Check your calculations! (+${score * 15} points)`;
                challengeStates[4] = { completed: score > total/2, score: score * 15 };
                totalScore += score * 15;
            }
            
            feedback.style.display = 'block';
            updateChallengeStats();
            
            if (challengeStates[4].completed) {
                document.getElementById('challenge4').classList.add('completed');
            }
        }

        function checkMatching() {
            const correctPairs = selectedQuestions.matching[0].pairs;
            let score = 0;
            let total = correctPairs.length;
            
            // Check each pair
            matchingPairs.forEach(pair => {
                const isCorrect = correctPairs.some(correctPair => 
                    (correctPair[0] === pair.left && correctPair[1] === pair.right)
                );
                
                if (isCorrect) {
                    score++;
                    correctAnswers++;
                    pair.elements.forEach(el => {
                        el.classList.remove('incorrect-match');
                        el.classList.add('correct-match');
                    });
                } else {
                    pair.elements.forEach(el => {
                        el.classList.remove('correct-match');
                        el.classList.add('incorrect-match');
                    });
                }
                totalQuestions++;
            });
            
            const percentage = Math.round((score / total) * 100);
            const feedback = document.getElementById('challenge5Feedback');
            
            if (score === total) {
                feedback.className = 'challenge-feedback success';
                feedback.innerHTML = `üéâ Perfect matching! All concepts paired correctly! (+${total * 20} points)`;
                challengeStates[5] = { completed: true, score: total * 20 };
                totalScore += total * 20;
                if (!challengeStates[5].completed) completedChallenges++;
            } else {
                feedback.className = 'challenge-feedback error';
                feedback.innerHTML = `You got ${score}/${total} pairs correct (${percentage}%). Try rearranging! (+${score * 10} points)`;
                challengeStates[5] = { completed: score > total/2, score: score * 10 };
                totalScore += score * 10;
            }
            
            feedback.style.display = 'block';
            updateChallengeStats();
            
            if (challengeStates[5].completed) {
                document.getElementById('challenge5').classList.add('completed');
            }
        }

        function resetChallenge(challengeNum) {
            // Reset challenge state
            challengeStates[challengeNum] = { completed: false, score: 0 };
            
            // Hide feedback and hints
            document.getElementById(`challenge${challengeNum}Feedback`).style.display = 'none';
            document.getElementById(`challenge${challengeNum}Hint`).classList.remove('active');
            
            // Remove completed styling
            document.getElementById(`challenge${challengeNum}`).classList.remove('completed');
            
            // Reset specific challenge content
            switch(challengeNum) {
                case 1:
                    challengeAnswers.quiz1 = {};
                    document.querySelectorAll('#quiz1Content .quiz-option').forEach(option => {
                        option.classList.remove('selected', 'correct', 'incorrect');
                    });
                    document.querySelectorAll('[id^="explanation_1_"]').forEach(exp => {
                        exp.classList.remove('active');
                    });
                    break;
                case 2:
                    challengeAnswers.advanced = {};
                    document.querySelectorAll('#advancedContent .quiz-option').forEach(option => {
                        option.classList.remove('selected', 'correct', 'incorrect');
                    });
                    document.querySelectorAll('[id^="advanced_explanation_"]').forEach(exp => {
                        exp.classList.remove('active');
                    });
                    break;
                case 3:
                    challengeAnswers.fillBlanks = {};
                    document.querySelectorAll('.fill-blank-input').forEach(input => {
                        input.value = '';
                        input.classList.remove('correct', 'incorrect');
                    });
                    document.querySelectorAll('[id^="fillblank_explanation_"]').forEach(exp => {
                        exp.classList.remove('active');
                    });
                    break;
                case 4:
                    challengeAnswers.calculations = {};
                    document.querySelectorAll('.numerical-input').forEach(input => {
                        input.value = '';
                        input.classList.remove('correct', 'incorrect');
                    });
                    document.querySelectorAll('[id^="numerical_explanation_"]').forEach(exp => {
                        exp.classList.remove('active');
                    });
                    break;
                case 5:
                    challengeAnswers.matching = [];
                    matchingPairs = [];
                    selectedMatchingItems = [];
                    document.querySelectorAll('.matching-item').forEach(item => {
                        item.classList.remove('selected', 'matched', 'correct-match', 'incorrect-match');
                        item.onclick = () => selectMatchingItem(item);
                    });
                    break;
            }
            
            updateChallengeStats();
        }

        function resetAllChallenges() {
            for (let i = 1; i <= 5; i++) {
                resetChallenge(i);
            }
            
            // Reset global stats
            totalScore = 0;
            completedChallenges = 0;
            hintsUsed = 0;
            totalQuestions = 0;
            correctAnswers = 0;
            
            updateChallengeStats();
        }

        function updateChallengeStats() {
            document.getElementById('totalScore').textContent = totalScore;
            document.getElementById('completedChallenges').textContent = completedChallenges;
            document.getElementById('hintsUsed').textContent = hintsUsed;
            
            const accuracy = totalQuestions > 0 ? Math.round((correctAnswers / totalQuestions) * 100) : 0;
            document.getElementById('accuracy').textContent = accuracy + '%';
            
            // Update progress bar
            const progress = (completedChallenges / 5) * 100;
            document.getElementById('challengeProgressBar').style.width = progress + '%';
        }

        function exportResults() {
            const results = {
                timestamp: new Date().toISOString(),
                totalScore: totalScore,
                completedChallenges: completedChallenges,
                hintsUsed: hintsUsed,
                accuracy: totalQuestions > 0 ? Math.round((correctAnswers / totalQuestions) * 100) : 0,
                challengeDetails: challengeStates
            };
            
            const dataStr = JSON.stringify(results, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = 'semiconductor_physics_challenge_results.json';
            link.click();
            
            URL.revokeObjectURL(url);
        }

        // Initialize when page loads
        window.addEventListener('load', init);
    </script>

    <!-- Floating Buttons -->
    <div class="floating-button tour" onclick="startGuidedTour()">
        <i class="fas fa-route"></i>
    </div>

    <div class="floating-button primary" onclick="toggleHelp()">
        <i class="fas fa-question"></i>
    </div>

    <!-- Tour Elements -->
    <div class="tour-overlay" id="tourOverlay">
        <div class="tour-spotlight" id="tourSpotlight"></div>
        <div class="tour-spotlight-secondary" id="tourSpotlightSecondary" style="display: none;"></div>
    </div>

    <div class="tour-popup" id="tourPopup">
        <div class="tour-header">
            <div class="tour-step-number" id="tourStepNumber">1</div>
            <h3 class="tour-title" id="tourTitle">Welcome!</h3>
        </div>
        <div class="tour-content" id="tourContent">
            Let's start exploring advanced semiconductor physics concepts!
        </div>
        <div id="tourChallenge"></div>
        <div class="tour-controls">
            <button class="tour-btn tour-btn-secondary" id="tourPrevBtn" onclick="prevTourStep()">Previous</button>
            <div>
                <span id="tourStepInfo">Step 1 of 15</span>
            </div>
            <button class="tour-btn tour-btn-primary" id="tourNextBtn" onclick="nextTourStep()">Next</button>
        </div>
    </div>

    <div class="tour-score" id="tourScore">
        <div class="tour-score-title">üèÜ Your Progress</div>
        <div class="tour-score-item">
            <span>Steps Completed:</span>
            <span id="stepsCompleted">0/15</span>
        </div>
        <div class="tour-score-item">
            <span>Challenges Solved:</span>
            <span id="challengesSolved">0/5</span>
        </div>
        <div class="tour-score-item">
            <span>Score:</span>
            <span id="totalScore">0</span>
        </div>
    </div>

    <div class="tour-achievements" id="tourAchievements">
        <div class="achievement-icon">üéâ</div>
        <div class="achievement-title" id="achievementTitle">Achievement Unlocked!</div>
        <div class="achievement-description" id="achievementDescription">You've mastered a new concept!</div>
        <button class="tour-btn tour-btn-primary" onclick="closeAchievement()">Continue</button>
    </div>

    <!-- Help Panel -->
    <div class="floating-panel" id="helpPanel">
        <div class="floating-panel-header">
            <h3 class="panel-title">Help & Information</h3>
            <div class="floating-panel-close" onclick="toggleHelp()">
                ‚úï
            </div>
        </div>
        <div class="floating-panel-content">
            <h4>Quick Guide:</h4>
            <p><strong>Band Structure:</strong> Explore E-k diagrams and energy bands in semiconductors.</p>
            <p><strong>Carrier Transport:</strong> Study drift, diffusion, and advanced transport mechanisms.</p>
            <p><strong>Temperature Analysis:</strong> Analyze temperature effects on carrier dynamics.</p>
            <p><strong>Challenges:</strong> Test your knowledge with physics problems.</p>
            
            <h4>Key Concepts:</h4>
            <p><strong>Effective Mass:</strong> m* = ‚Ñè¬≤/(d¬≤E/dk¬≤) - determines carrier mobility</p>
            <p><strong>Density of States:</strong> g(E) ‚àù ‚àöE for 3D systems</p>
            <p><strong>Fermi-Dirac Distribution:</strong> f(E) = 1/(1 + exp((E-EF)/kT))</p>
            <p><strong>Einstein Relation:</strong> D = ŒºkT/q relates diffusion and mobility</p>
            
            <h4>Features:</h4>
            <p><strong>üéØ 5 Challenge Types:</strong> MCQs, fill-in-blanks, numerical, advanced concepts, matching</p>
            <p><strong>üèÜ Achievements:</strong> Unlock badges for mastering concepts</p>
            <p><strong>üìä Dynamic Questions:</strong> Questions randomize on each page load</p>
            <p><strong>üí° Smart Hints:</strong> Context-aware help system</p>
        </div>
    </div>
</body>
</html>